---
title: WebSocket连接过程及原理分析
date: 2022-04-30 11:06:13
permalink: /pages/4d7766/
article: false
categories:
  - 文章
  - 前端
tags:
  - WebSocket
---

## 前言

最近在面试的过程中有被问及到`websocket`的连接过程（简历中项目有使用到`websocket`），一时有点懵，以为是在问使用方式，后来确定了下是在问网络层面的连接过程，是如何进行的，以及`http`和`socket`的过程。

我只做过心跳和断网重连的一些基本使用，对原理层面知之甚少。对于简历中的项目涉及到的`websocket`技术还是属于了解的比较浅的，问题很有点大啊。总的来说对于简历中的技术应该还是要做到比较熟悉才行，项目和技术栈还是有必要好好准备一番的。

## 为什么需要WebSocket

主要原因就是：**HTTP 协议通信只能由客户端发起**（主要缺陷）。

对于状态监听并在变化后推送消息通知这种场景，在此之前常用的手段一般是轮询：**每隔一段时候，就发出一个询问，了解服务器有没有新的信息**（轮询的效率低，非常浪费资源——因为必须不停连接，或者 `HTTP` 连接始终打开）。

## 简介

首先，`WebSocket`和`http`协议一样， 都是一种网络通信协议。

`WebSocket` 协议在2008年诞生，2011年成为国际标准（目前主流浏览器都支持，不存在兼容问题）。

![WebSocket兼容性](https://cdn.jsdelivr.net/gh/JS-banana/images/vuepress/websocket-1.webp)

### 一些特点

它的最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于服务器推送技术的一种。

![WebSocket双向平等对话](https://cdn.jsdelivr.net/gh/JS-banana/images/vuepress/websocket-2.webp)

1. 更强的实时性：由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。
2. 更小的控制开销：数据格式比较轻量，性能开销小，通信高效（用于协议控制的数据包头部相对较小）。
3. 良好的`HTTP`协议兼容性：与 `HTTP` 和 `HTTPS` 使用相同的 `TCP` 端口，握手阶段采用 `HTTP` 协议，协议标识符是`ws`（如果加密，则为`wss`）
4. 更好的二进制支持：可以发送文本，也可以发送二进制数据（定义了二进制帧）。
5. 可在单个 `TCP` 连接上进行全双工通信，位于 OSI 模型的应用层。
6. 没有同源限制，客户端可以与任意服务器通信。

![WebSocket的ws和wss](https://cdn.jsdelivr.net/gh/JS-banana/images/vuepress/websocket-3.webp)

### 基本用法

```js
const ws = new WebSocket("wss://echo.websocket.org");

ws.onopen = function(evt) { 
  console.log("Connection open ..."); 
  ws.send("Hello WebSockets!");
};

ws.onmessage = function(evt) {
  console.log( "Received Message: " + evt.data);
  ws.close();
};

ws.onclose = function(evt) {
  console.log("Connection closed.");
};      
```

### 主要API

- WebSocket 对象作为一个构造函数，用于新建 WebSocket 实例（[相关API见官网](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket)）。
- 核心属性：`onopen`、`onclose`、`onerror`、`onmessage`、`binaryType`、`readyState`等9个。
  - `onopen`：用于指定连接成功后的回调函数
  - `onclose`：用于指定连接关闭后的回调函数
  - `onerror`：用于指定连接失败后的回调函数
  - `onmessage`：用于指定当从服务器接受到信息时的回调函数
  - `binaryType`：使用二进制的数据类型连接（`binaryType: "blob"`）
  - `readyState`（只读）：返回当前 WebSocket 的连接状态，共有 4 种状态
- 核心方法：`send`、`close`。
  - `send`：该方法将需要通过 WebSocket 链接传输至服务器的数据排入队列
  - `close`：该方法用于关闭 WebSocket 连接
- 事件：`open`、`close`、`error`、`message`（配合`addEventListener`方法使用，与通过上面`onopen`、`onclose`等4个属性方法设置使用一样）。

```js
// readyState
- CONNECTING — 正在连接中，对应的值为 0；
- OPEN — 已经连接并且可以通讯，对应的值为 1；
- CLOSING — 连接正在关闭，对应的值为 2；
- CLOSED — 连接已关闭或者没有连接成功，对应的值为 3
```

## 资料

- [WebSocket 教程](https://www.ruanyifeng.com/blog/2017/05/websocket.html)
- [万字长文，一篇吃透WebSocket：概念、原理、易错常识、动手实践](https://segmentfault.com/a/1190000040793931)
