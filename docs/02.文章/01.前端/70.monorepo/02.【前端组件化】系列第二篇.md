---
title: 【前端组件化】系列第二篇——monorepo方案实战
date: 2022-09-05 15:52:50
permalink: /pages/eb2149/
categories:
  - 文章
  - 前端
tags:
  - monorepo
---

> 前端组件化系列文章第二篇
>
> 一个使用 pnpm + workspace + changeset 的 monorepo 多包管理组件化项目

<!-- more -->

## 前言

在上一篇的[方案探究](01.【前端组件化】系列第一篇.md)中，我们搞清楚了什么是组件化以及我们为什么需要组件化的一些研究和讨论。也调研和测试了一些开源项目，并且在使用、学习、研究、对比之后最终确定了以 pnpm + workspace + changeset 为技术方向的 monorepo 多包管理方案。

- 本文主要是沿着该路线进行项目落地，是一篇聚焦于实践的文章。
- 本篇文章的目标是能够让未接触过monorepo的新手也能从0到1的完成一个项目

细致一点的说，我们主要从这几个方面入手：

1. monorepo项目架构的搭建
2. 整个项目的工程化规范搭建
3. 子项目的配置和构建配置，包括出入口管理、webpack打包
4. 文档站点的搭建
5. 版本管理和发布

## 使用 pnpm 快速搭建一个 monorepo 项目

在上一篇文章中我们描述了什么是monorepo，以及pnpm的workspace工作空间概念，简单理解的话就是两个方面：

- 如何通过一个工程管理多个项目
- 如何通过一个工程管理多个项目的依赖

### 创建主项目

首先，我们先创建一个主项目，在命令行中执行：

1. `mkdir my-monorepo-app && cd my-monorepo-app`
2. `pnpm init`

接下来我们创建一个**packages**目录作为我们的子项目目录使用，然后再创建几个子项目，如下：

```js
├── package.json
├── packages           // 子项目目录
  ├── components       // UI基础组件
  ├── pro-sqltiptree   // 高级业务组件
  ├── utils            // 工具类
```

在主目录下简单配置下`.gitignore`：

```.gitignore
# IDE user config
.vscode/
.idea/
.vs/

/**/.DS_Store
/**/node_modules/
/**/.env

# /**/dist
docs/**/dist

# Logs
/**/yarn-error.log
/**/npm-debug.log
/**/lerna-debug.log
/**/.pnpm-debug.log
```

准备工作差不多了，接下来我们配置下工作空间（`workspace`），为安装npm包和依赖管理做准备

其实对于使用pnpm的项目来说，还是比较简单的，我们只需要在主目录下创建一个`pnpm-workspace.yaml` 文件即可开启pnpm的工作空间功能。

> pnpm 内置了对单一存储库（也称为多包存储库、多项目存储库或单体存储库）的支持， 你可以创建一个 workspace 以将多个项目合并到一个仓库中。

Workspace 协议更多的是对一个项目下多子项目的管理以及依赖管理。

我们先把`packages`目录添加到工作空间中，`pnpm-workspace.yaml`配置如下：

```yml
packages:
  - packages/*
```

### 安装依赖

monorepo最主要的功能就是对于依赖的管理

#### 1. 全局共用的依赖

对于使用比较频繁的依赖，在多个子项目中都有用到的情况，比如我们当前技术栈为vue2，那么核心库 `vue`、`vue-router`基本都会用到，也包括一些通用工具，如 `lodash`、`dayjs`等，此时，就可以采用全局安装的方式，这样只需要安装一次相同的依赖，所有的子项目都可以引入使用。

> 如果全局中没有依赖，而子项目中有相同的依赖，你也不用担心，pnpm也会自动优化处理，通过软连接的方式安装一次就可以，可以实现最小化安装产物，非常的好用😎~

```bash
pnpm i vue@^2.6.11 dayjs -Dw
```

- `pnpm i` 与 `pnpm add` 功能是一样的
- `-D`：作为开发依赖使用
- `-w`：表示把包安装在 root 下，该包会放置在 `<root>/node_modules` 下

#### 2. 单一子项目的依赖

#### 3. 子项目互相作为依赖
