---
title: 【配置文件分析】——json、yaml、toml
date: 2022-09-06 18:53:10
permalink: /pages/131a7a/
categories:
  - 文章
tags:
  - 
---

## 前言

配置文件，不言而喻，主要是我们进行项目和工程配置的文件。

如果是站在前端角度说的话，我们最常接触的就是 `json`以及 `js`类型的文件，这种形式的配置写法对前端非常友好，因为都是我们熟悉的 JS 对象结构，如：

- `package.json`
- `webpack.config.js`
- `babel.config.js`
- `vue.config.js`

<!-- more -->

不过，随着技术的更新迭代，也涌现出一些新的配置文件格式，相比较而言，原有的文件格式好像也变得不是那么好用了。虽然在此之前，`json`+`js`用着也不错，不过，当新的工具出现后，尤其是在你深度体验与使用之后，可能会发现事情似乎有点那么不一样了，感觉新的玩意就是好啊😏，也便开始嫌弃之前的家伙了~

不过，我们要站在不同角度思考问题，从新工具诞生的角度看，其诞生必然有着一定的历史背景存在，如：

1. 旧工具在某些场景表现吃力，需要更优的替代方案
2. 旧的写法和模式在某些场景下有着明显的短板和缺陷，需要更进一步的完善方案

## 背景

最近在做开源项目的时候，在开发功能时，考虑到不同场景、不同用户的不同需求，在开始设计功能时就考虑到预留一定的可定制窗口方便用户进行定制化配置。当然，在功能不断开发进行时，以及后期的迭代拓展时，都会源源不断的诞生出各种小功能和定制需求，因此，对于拥有一个足够简单、易用、拓展的配置文件是相当有必要的。

它应该具备以下基本能力：

1. **支持注释**：对于配置文件来说，注释的重要性不必多说，它需要描述每个配置字段的作用
2. **足够简单**：语法足够简单，用法足够简单，上手足够简单；至少保证新人能很快上手使用
3. **方便读写**：对于用户来说，应该是可读性非常高的，符合人类语言习惯的，概览之后可以快速上手配置

在此之前的版本，我已经针对该想法做了初步的实施落地，从个人经验来说，我之前在搞 CI/CD 自动化部署相关的东西时，写过一些 **github action**（配置文件为`yaml`格式），因此，对于`yaml`语法算是有些了解。

从使用感受上来说，它语法**更简洁**、**支持注释**，所以，我果断选择了`yaml`作为我对于项目的配置文件格式。

不过，在这段时间的使用过程中，我也发现了`yaml`存在的一些问题，因此，最近我又重新思考了一下下这个问题：

1. 是继续按照传统的`js`文件的对象写法呢？
2. 还是继续使用`yaml`作为配置文件使用呢？
3. 还是进一步研究一些其他类型的配置文件呢？
4. 这些配置文件类型又有啥本质区别呢？

抱着学习的心理，咱不能在遇到问题的时候就选择逃避呀，那么本篇文章也算是对不同类型配置文件的一种研究和学习了。

## 简单介绍

### JSON

`JSON`的定义一般是作为数据格式，它通常用于序列化、结构化数据并通过网络进行交换，通常发生在服务器与 Web 应用之间。不过也有很多工具将其作为配置文件使用。

> JSON 其实完全可以当成是 JS 对象的形式进行理解、使用。

其实使用`JSON`作为配置文件也有其一定的优势：

1. 语法非常简单，纯粹的键值对结构
2. 很多编程语言的标准库都支持 `JSON`，比如：在JS当中你可以直接引入读取
3. 现在几乎所有的工具都提供 `JSON` 支持，包括语法突出显示、自动格式化、验证工具等。
4. 采用人类可读的轻量级文本，只需更少的编码，处理速度更快

但是，也因为其独特的定位，它天生就注定了**并不适合作为配置文件使用**，原因也很明显：

1. **不支持注释**：对于配置文件来说，注释的重要性不言而喻，但是`JSON`不支持添加注释（`JSON` 作为一种数据交换格式，也不需要注释😅）
2. **语法过于严格**：键和字符串必须使用`""`双引号（其实对于键来说，并不需要使用引号），结尾不允许有逗号（除了结尾都必须有逗号，哈哈~）
3. **多余的最外层大括号**：作为配置文件来说，最外层的大括号也显得有些多余（这也是其作为交换数据格式的特点，为了界定不同的对象）

虽然大家都很熟悉了，我们还是按流程看下基本用法，方便接下来做对比，如下：

```json
{
  "name": "cat",
  "desc": {
    "color": "orange",
    "age": 1
  }
}
```

可以看出`JSON`作为数据格式，还是比较合适且优秀的，但是作为配置文件来说，总觉得是力气使错了方向😄

### YAML

YAML 是一种数据序列化语言，通常用于编写配置文件（它的流行和 **k8s** 脱不了关系😏~）。

语法规则：

- 大小写敏感
- 使用缩进表示层级关系
- 缩进时不允许使用Tab键，只允许使用空格。
- 缩进的空格数目不重要，只要相同层级的元素左侧对齐即可
- `#` 表示注释，从这个字符一直到行尾，都会被解析器忽略。
- 文件拓展名为 `.yaml`、`.yml`

支持的数据格式：

- 对象：键值对的集合，又称为映射/ 哈希 / 字典
- 数组：一组按次序排列的值，又称为序列 / 列表
- 纯量：单个的、不可再分的值，可以理解为基本类型

其特点如下：

1. 有更好的可读性，对用户更友好
2. 简洁和强大，写法简洁，也有复杂的语法支持不同功能
3. **是JSON的超集**，JSON 文件在 YAML 中有效
4. 使用 Python 风格的*缩进*来表示嵌套

如果说到缺点的话，那和它的特点也是密不可分的

1. 因为不是原生支持的格式，不同平台需要专门的解析工具（如：在JS中使用需要使用[`js-yaml`](https://www.npmjs.com/package/js-yaml)解析，[在线转换](https://nodeca.github.io/js-yaml/)）
2. 简单使用，基本语法够简单；但是进阶使用，语法就比较复杂了，对于多行字符串的处理也有待优化，尤其是结合缩进语法一起
3. 缩进语法，如果搞错了缩进或者没看清，够你定位问题的了

按惯例，看下基本用法：

```yaml
name: cat
desc:
  color: orange
  age: 1
```

同时上面的内容也可以这样写：

```yaml
name: cat
desc: { color: orange, age: 1 } # JSON的超集
```

转为JS如下：

```js
{ 
  name: 'cat', 
  desc: { 
    color: 'orange', 
    age: 1 
  } 
}
```

### TOML

全称 `Tom's Obvious, Minimal Language`，意为语义**明显的**、配置**最小化的**的语言。

官方描述：

为人而生的配置文件格式（好屌的感觉😏~）。

TOML 旨在成为一个语义明显且易于阅读的最小化配置文件格式。TOML 被设计成可以无歧义地映射为哈希表。TOML 应该能很容易地被解析成各种语言中的数据结构。

1. TOML 以人为先
   - 语义明显易于阅读
   - 能无歧义地映射为哈希表
   - 易于解析成各种语言中的数据结构
2. TOML 具备实用的原生类型
   - 键/值对
   - 数组
   - 表
   - 内联表
   - 表数组
   - 整数 & 浮点数
   - 布尔值
   - 日期 & 时刻，带可选的时区偏移
3. TOML 受到广泛支持
   - TOML 已经拥有大多数当今使用的最流行的编程语言的实现：C、C#、C++、Clojure、Dart、Elixir、Erlang、Go、Haskell、Java、Javascript、Lua、Objective-C、Perl、PHP、Python、Ruby、Swift、Scala……以及更多。

语法规则：

- 大小写敏感
- 文件必须是合法的 UTF-8 编码的 Unicode 文档
- 简洁、清晰的 `=` 写法（`name = "cat"`）
- 字符串需要由引号（`"`）包裹
- 表写法，键值对的集合，由表头定义，连同方括号作为单独的行出现
- `#` 表示注释
- 文件拓展名为 `.toml`

其特点如下：

1. 写法符合直觉、简单清晰
2. 键名写法强大，键名可以是裸露的，引号引起来的，或点分隔的。
3. 对字符串支持完善，基本字符串、多行基本字符串、字面量和多行字面量
4. 表写法功能强大，键值对、数组、嵌套写法等

缺点：

1. 不是原生支持的格式，不同平台需要专门的解析工具（如：在JS中使用需要使用[`@ltd/j-toml`](https://www.npmjs.com/package/@ltd/j-toml)解析，[在线转换](http://binarymuse.github.io/toml-node/)）
2. 属于比较新型的格式，社区认知度不高
3. 新人对核心语法“表”需要适应

基本用法如下：

```toml
name = "cat"

[desc]
color = "orange" 
age = 1 
```

你也可以这样写：

```toml
name = "cat"

desc.color = "orange" 
desc.age = 1 
```

转为JS如下：

```js
{ 
  name: 'cat', 
  desc: { 
    color: 'orange', 
    age: 1 
  } 
}
```

## 用法对比

其实站在配置文件的角度思考，我们最关注的就是**键值对**，谁能做到在使用时读写更方便，谁也就更具有优势。

以我的这个项目为例（微信自动给女朋友发早安），用户需要参与配置的内容包括：

- 女友的名称
- 女友的生日
- 是否开启天气提醒
- 自定义俏皮内容
- 是否开启生日倒计时
  - 女友的生日
  - 我的生日
  - 倒计时多少天时开始提醒

基本上就是一个对象结构，数据类型包括字符串、对象、数组、布尔值、日期、数值等

```js
{ 
  "key" : value // 这里的 value 应可以是以上的任何类型
}
```

### 字符串

#### 1️⃣ 简单字符串用法

- json写法：

    ```json
    { 
      "name" : "cat"
    }
    ```

    最外层花括号 `{}` 不可缺少，且不主持添加注释，`key` 和 `value` 都需要使用引号 `""` 进行包裹

- yaml写法：

    ```yaml
    name: cat # 猫
    ```

    默认不需要使用引号 `""` 进行包裹，简单字符串使用非常简单，对于多行字符串则有所不同。

    特别注意的是：冒号 `:` 后面要有空格，这符合 yaml 后面的所有语法规范

- toml写法：

    ```toml
    name = "cat"
    ```

    有没有空格无所谓，不影响解析，value部分如何是字符串需要按照字符串的写法使用，即使用引号 `""` 进行包裹

#### 2️⃣ 多行字符串

有些场景我们可能会定义很长的一段字符串，默认展示肯定是在一行显示的，这样既不好读也不好维护，尤其针对一些 shell 命令，我们在前端工程中应该见过不少这样的。

我举个列子：

```json
"scripts": {
  "dev": "webpack-dev-server --base test/ --port 8081 --config build/webpack.dev.config.js",
  "lint:fix:utils": "eslint --fix \"./packages/utils/**\" --ext .js,.ts,.json"
}
```

- json写法：

    不支持

- yaml写法：

    ```yaml
    # 注意缩进，第二行、第三行开头有空格（必须这样写）
    dev: webpack-dev-server --content-base test/ 
      --port 8081 
      --config build/webpack.dev.config.js
    ```

    字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为空格。

- toml写法：

    ```toml
    dev = """
    webpack-dev-server --base test/ 
    --port 8081 
    --config build/webpack.dev.config.js
    """
    ```

    多行基本字符串由三个引号包裹，允许折行。

    紧随开头引号的那个换行会被去除，其它空白和换行会被原样保留。

    特别注意：`@ltd/j-toml`解析库目前支持自定义拼接，比如你想要以 `' '`空格进行拼接，而不使用换行`'\n'`拼接（`TOML.parse(data, { joiner: ' ' })`），以本例举例，我换行是为了易读，在解析之后的命令应该还是一行的、一个整体的，就可以使用这种方式

    你还可以用行末反斜杠自动剔除非空白字符前的任何空白字符：

    ```toml
    dev = """
    webpack-dev-server --base test/ \
          --port 8081 \
          --config build/webpack.dev.config.js \
    """
    ```

    解析结果如下：

    ```js
    {
      dev: 'webpack-dev-server --base test/ --port 8081 --config build/webpack.dev.config.js'
    }
    ```

#### 3️⃣ 字面量字符串

为了方便理解，你把它当成JS的模板字符串即可，没有转义行为，所见即所得。

这里以保留换行为例说明:

- json写法：

    不支持，JSON只能用引号`""`，但是如果你想保留类似换行操作符一样的东西，你可以这样做

    ```json
    { 
      "hi": "echo hello \n world \n 我是小明",
      "ha": "echo \"hello\" \"world\""
    }
    ```

    很烦，看着就难受的一批，写法也很操蛋~，我只能说“打扰了”😀

    换行需要添加 `\n`，以及你要是想在JSON中输出引号`""`，就必须进行转义

- yaml写法：

    在首行加一个 `|` 符号即可，还是蛮简单的，缩进一定要把握好~

    ```yaml
    hi: |
      echo hello
      world
      我是小明
    ```

    解析为JS如下：

    `{ hi: 'echo hello\nworld\n我是小明\n' }`

- toml写法：
  
    字面量字符串由单引号包裹，不能换行

    ```toml
    path = 'C:\Users\nodejs\templates'
    path2 = '\\User\admin$\system32'
    quoted = 'Tom "Dubs" Preston-Werner'
    regex = '<\i\c*\s*>'    
    ```
  
    多行字面量字符串两侧各有三个单引号来包裹，允许换行。

    ```toml
    # 三个单引号包裹
    hi = '''
    echo 
    hello 
    world 我是小明
    '''
    ```

    解析为JS如下：

    `{ hi: 'echo \nhello \nworld 我是小明\n' }`

    解析规则`TOML.parse(data, { joiner: '\n' })`

#### 字符串用法小结

总的来说，JSON对于字符串的支持还是比较弱的，对于多行字符串等写法使用比较吃力；yaml总体来说简单方便，对字符串的支持还是不错的，相关解析库也很易用，唯一需要注意的就是缩进需要把控好；如果要说对字符串的支持能力，toml是最强的毋庸置疑，也没有缩进语法的担忧，几乎支持你所能相到的任何场景，不过，目前确实存在使用量不高，第三方解析库不太稳定的问题。

npm周下载量（Weekly Downloads）大致如下：

- [js-yaml](https://www.npmjs.com/package/js-yaml)：`53,724,459`
- [@ltd/j-toml](https://www.npmjs.com/package/@ltd/j-toml)：`33,951` （1.0版本后官方指定的解析库）
- [toml](https://www.npmjs.com/package/toml)：`666,591`（0.4版本，缺少维护）

千万级别和万级别的对比~

> `@ltd/j-toml`解析库对于多行字符串，必须要手动指定拼接规则，有点没搞明白，当时测试这一块的时候搞得有点懵，为啥一个规范语法解析库会有自定义规则的行为操作，没搞懂，不知道是不是我没理解正确的用法😅

### 对象

### 数组

### 嵌套组合

## 资料

- [toml](https://toml.io/cn/v1.0.0)
- [TOML 教程 - 可能是目前最好的配置文件格式](https://zhuanlan.zhihu.com/p/50412485)
- [现代配置指南——YAML 比 JSON 高级在哪？](https://segmentfault.com/a/1190000041108051)
- [什么是 YAML？](https://www.redhat.com/zh/topics/automation/what-is-yaml)
- [YAML 语言教程](https://www.ruanyifeng.com/blog/2016/07/yaml.html)
- [@ltd/j-toml](https://www.npmjs.com/package/@ltd/j-toml)
