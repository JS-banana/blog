---
title: NodeJsè·å–ç…§ç‰‡ä¿¡æ¯å¹¶åˆ†ç±»
date: 2021-11-14 17:46:34
permalink: /pages/d42185/
categories:
  - æ–‡ç« 
  - NodeJs
tags:
  - å›¾ç‰‡
---

NodeJs è·å–ç…§ç‰‡æ‹æ‘„æ—¥æœŸï¼Œå¹¶æŒ‰æ—¥æœŸç›®å½•/åç§°å­˜æ¡£

<!-- more -->

## å‰è¨€

ä¸€å¼€å§‹æƒ³ç€å¥³æœ‹å‹ç”Ÿæ—¥å¿«åˆ°äº†ï¼Œæƒ³å‡†å¤‡ä¸ªæœ‰æ„ä¹‰çš„ç¤¼ç‰©å•¥çš„ï¼Œçœ‹äº†æ‰‹æœºå’Œæ–‡ä»¶å¤¹é‡Œçš„è¿™ä¹ˆå¤šç…§ç‰‡ï¼ˆåœ¨ä¸€å—æ‹äº†å¾ˆå¤šç…§ç‰‡ï¼‰ï¼Œå¹²è„†åšä¸ªç›¸å†Œï¼Œä¹Ÿæ˜¯ä¸€ä»½å¾ˆæ£’çš„å›å¿†å’Œçºªå¿µå‘€

åˆæ­¥æƒ³æ³•æ˜¯ï¼š

- ç›´æ¥æ‰¾æœ‹å‹å†æ‰“å°ä¸€ä»½å®ä½“ç›¸å†Œï¼ˆéœ€è¦ç­›é€‰åˆ†ç±»æŒ‘ä¸€éƒ¨åˆ†ï¼‰
- åšä¸ªä»¥ç›¸å†ŒåŠŸèƒ½ä¸ºä¸»çš„ç½‘ç«™/å°ç¨‹åºï¼ˆè¿™ä¸ªè¿˜æ²¡æƒ³å¥½ï¼Œä¸è¿‡æ•°æ®å¯ä»¥å…ˆå‡†å¤‡ç€ï¼‰

ä½†æ˜¯åŸºæœ¬èƒ½åŠ›è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼š

- æ‹æ‘„æ—¥æœŸ
- åˆ†ç±»

æœŸå¾…å®Œå–„çš„èƒ½åŠ›æ˜¯ï¼š

- GPSå®šä½ä¿¡æ¯ä¸å¯è§†åŒ–èƒ½åŠ›ç»“åˆ

è¿™é‡Œè¿˜æ˜¯ä»¥æˆ‘æ¯”è¾ƒç†Ÿæ‚‰çš„ Nodejsä¸ºä¾‹

## èƒ½åŠ›åˆ†æ

- æ‹æ‘„æ—¥æœŸ

ä¸åŒäºæ–‡ä»¶åˆ›å»ºæ—¥æœŸï¼Œæ‹æ‘„æ—¥æœŸæ˜¯ç»å¯¹ç¨³å®šä¸å˜å¤§çš„ï¼ˆæ–‡ä»¶æ—¥æœŸä¼šåœ¨ç§»åŠ¨æ—¶å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œå› æ­¤ï¼Œè¿™é‡Œå°±éœ€è¦ä¸€äº›å¯ä»¥è§£æå›¾ç‰‡æ•°æ®èƒ½åŠ›çš„å¼€æºåº“äº†ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ nodejsåŒ… `exif`

å®ƒå…·æœ‰ä»¥ä¸‹èƒ½åŠ›ï¼š

ä»å›¾åƒï¼ˆJPEGï¼‰ä¸­æå–Exifå…ƒæ•°æ®ï¼Œç›¸æœºåœ¨å›¾åƒæ–‡ä»¶ä¸­ä¿å­˜å…³äºå›¾åƒçš„é¢å¤–ä¿¡æ¯ï¼šç›¸æœºå‹å·ã€åˆ†è¾¨ç‡ã€å›¾åƒçš„æ‹æ‘„åœ°ç‚¹ï¼ˆGPSï¼‰æˆ–æ‹æ‘„æ—¶é—´ã€‚

è¿™é‡Œæˆ‘ç®€å•åˆ—ä¸¾éƒ¨åˆ†å±æ€§ï¼š

[æ–‡æ¡£](https://www.npmjs.com/package/exif)

```js
{
  image: {
    ImageWidth: 3648,
    ImageHeight: 2736,
    Make: 'HUAWEI',
    ModifyDate: '2021:05:04 12:55:57',
    // ...
  },
  exif: {
    ISO: 200,
    DateTimeOriginal: '2021:05:04 12:55:57',
    CreateDate: '2021:05:04 12:55:57',
    LightSource: 1,
    Flash: 0,
    FocalLength: 5.58,
    // ...
  },
  gps: {
    // ...
  },
}
```

`CreateDate` å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŒ‰æ—¥æœŸï¼Œä»¥æœˆæˆ–è€…å¹´çš„ç»´åº¦å»åšä¸€äº›å½’ç±»å¤„ç†ï¼Œä»¥æ—¶é—´è½´...

`imgge`ã€`GPS`ä¿¡æ¯å¯ä»¥åœ¨å¼€å‘ç›¸å†Œç½‘ç«™åŠŸèƒ½æ—¶æä¾›èƒ½åŠ›

è§£å†³äº†æ•°æ®è·å–çš„é—®é¢˜åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒå¸¸è§„ä¸€äº›çš„æ“ä½œäº†

## æ ¹æ®æ—¥æœŸç®€å•åˆ†ç±»

æ¯”å¦‚æˆ‘è¿™é‡Œæ‰“ç®—ä»¥æ—¶é—´è½´çš„å½¢å¼å»æè¿°å’Œåˆ†ç±»

ä»¥2021å¹´ä¸ºä¾‹ï¼ŒæŒ‰æœˆä»½åšç»†ç²’åº¦åˆ’åˆ†

```js
// å…ˆå®šä¹‰ä¸‹åˆ†ç±»

5: "521&å—äº¬æ¸¸",
6: "ç«¯åˆ",
7: "æ­å·æ¸¸",
8: "ä¸ƒå¤•",
9: "å¤§å­¦åŸ&ä¸­ç§‹èŠ‚",
// ...
```

é‚£è¿™é‡Œçš„è¯ï¼Œå¯ä»¥ç»“åˆè‡ªèº«éœ€æ±‚ï¼š

- æ˜¯æŠŠç…§ç‰‡æŒ‰ç…§æœˆä»½å½’ç±»åˆ°å•ç‹¬çš„æ–‡ä»¶å¤¹å»
- è¿˜æ˜¯æŠŠåŸºæœ¬ä¿¡æ¯å‘ˆç°åœ¨ç…§ç‰‡åç§°ä¸­

è¿™é‡Œæˆ‘ä¸ºäº†åšç›¸å†Œæ–¹ä¾¿ï¼Œå…ˆç»Ÿä¸€æŒ‰åç§°åˆ’åˆ†å¤„ç†

æŒ‰æ–‡ä»¶å¤¹åˆ’åˆ†å¯¹äºæ•´ç†å’Œç½‘ç«™ä½¿ç”¨å¾ˆå¯ä»¥çš„ ğŸ‘€

## ä»£ç 

å¼€å§‹ä¹‹å‰å…ˆå®‰è£…ä¸‹å¸¸ç”¨ä¾èµ–ï¼š`fs-extra`ã€`pify`

### è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰ç…§ç‰‡

è¿™é‡ŒæŒ‰æœ€ç®€å•å¤„ç†ï¼Œå…ˆä¸è€ƒè™‘åµŒå¥—é€’å½’

```js
const fs = require("fs-extra");
const pify = require("pify");

// è¯»å–ç›®å½•
const readDir = async () =>{
  const dir = await pify(fs.readdir(dirPath));
}
```

### è¯»å–å›¾ç‰‡ä¿¡æ¯

- æ ¼å¼è¿‡æ»¤

```js
const path = require("path");

// æ–‡ä»¶æ ¼å¼
const ext = path.extname(currentPath);
// .jpg
```

- è¯»å–ä¿¡æ¯

```js
const Exif = require("exif");

const readImg = async (currentPath) => {
  const imgInfo = await pify(Exif.ExifImage)({
    image: currentPath,
  });
  // æ–‡ä»¶æ ¼å¼
  const ext = path.extname(currentPath);

  // è·å–æ—¥æœŸ 2021:05:04 12:55:57
  const createDate = imgInfo.exif.CreateDate
  const date = new Date(.replace(":", "-").replace(":", "-"));

  return {
    currentPath,
    date,
    ext
  }
}
```

è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œå¯ä»¥ç”¨ `Promise.all`åŒ…è£…ä¸€ä¸‹

```js
const res = await Promise.all(dir.map(readImg))
```

- æŒ‰æ—¥æœŸæ’åº

```js
const sortData = res.sort((a, b) => a.date - b.date);
```

### é‡å‘½åå¤„ç†

æ‹¿åˆ° `sortData`æ•°æ®ï¼ŒåŒæ ·æŒ‰ç…§ dirçš„æ–¹å¼å¤„ç†

```js
const result = await Promise.all(renameFile)
```

ç›®æ ‡æ•ˆæœï¼š`5æœˆ21æ—¥(521&å—äº¬æ¸¸)-1.jpg`

```js
// æ¥è‡ªäºå…¥å£å‡½æ•°
// toDir = ''
// sortArr={}

const renameFile = async () => sortData.map(async ({ currentPath, date, ext }) => {
    // åŸºæœ¬ä¿¡æ¯ï¼š æœˆ æ—¥ æè¿°
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const desc = MONTHS[month] || "æœªåˆ†ç±»";

    // ä»¥æœˆä»½å†…éƒ¨æ’åº
    sortArr[month] = sortArr[month] || [];
    const len = sortArr[month].length + 1;
    sortArr[month].push(len);

    const fileName = `${month}æœˆ${day}æ—¥(${desc})-${sortArr[month].length}`;

    const newPath = toDir + fileName + ext; // 5æœˆ21æ—¥(521&å—äº¬)-1.jpg

    // åˆ¤æ–­æ˜¯å¦è¿‡æ»¤å·²å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶
    if (fs.existsSync(newPath)) {
      console.log(currentPath, "å·²å­˜åœ¨", newPath);
    }
    // æ–‡ä»¶é‡å‘½å
    if (!isDebug) {
      fs.renameSync(currentPath, newPath);
    }
    console.log(currentPath, "ç§»åŠ¨åˆ°", newPath);

    return { fileName, date };
})
```

ä¸»å‡½æ•°

```js
/**
 * @param {String} dirPath æ¥æºç›®å½•
 * @param {String} toDir ç›®æ ‡ç›®å½•
 * @param {Boolean} isDebug æ˜¯å¦è°ƒè¯•æ¨¡å¼ã€‚è°ƒè¯•æ¨¡å¼åªä¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼Œä¸ä¼šçœŸæ­£æ“ä½œæ–‡ä»¶
 */

const main = async (dirPath, toDir, isDebug = true) => {
  // 
}
```

### å®Œæ•´ä»£ç å¦‚ä¸‹

```js
const NmExif = require("exif");
const pify = require("pify");
const fs = require("fs-extra");
const path = require("path");

const MONTHS = {
  5: "521&å—äº¬æ¸¸",
  6: "ç«¯åˆ",
  7: "æ­å·æ¸¸",
  8: "ä¸ƒå¤•",
  9: "å¤§å­¦åŸ&ä¸­ç§‹èŠ‚",
};

const main = async (dirPath, toDir, isDebug = true) => {
  let prefix = "";
  let sortArr = {};

  // ä¸å­˜åœ¨
  if (!fs.existsSync(dirPath)) return console.log("no path!");
  // è‡ªåŠ¨è¡¥é½è·¯å¾„ç¬¦
  const SEP = path.sep;
  if (!dirPath.endsWith(SEP)) {
    dirPath += SEP;
  }
  if (!toDir.endsWith(SEP)) {
    toDir += SEP;
  }

  prefix = dirPath;

  // è¯»å–ç›®å½•
  const dir = await pify(fs.readdir(dirPath));

  // è¯»å–æ—¶é—´
  const res = await Promise.all(
    dir.map(async (filePath) => {
      const currentPath = prefix + filePath;
      let date = "";

      // æ–‡ä»¶æ ¼å¼
      const ext = path.extname(currentPath);

      if (!ext) return null;
      if (ext === ".jpg" || ext === ".jpeg") {
        // æœ‰å¯èƒ½è¯»å–ä¸åˆ°ä¿¡æ¯
        try {
          const createDate = await pify(NmExif.ExifImage)({
            image: currentPath,
          });

          // 5æœˆ21æ—¥(521&å—äº¬)-1.jpg
          date = new Date(createDate.exif.CreateDate.replace(":", "-").replace(":", "-"));
        } catch (error) {
          //
        }
      }

      return {
        currentPath,
        date,
        ext,
      };
    })
  );

  const sortData = res.sort((a, b) => a.date - b.date);

  const result = await Promise.all(
    sortData.map(async ({ currentPath, date, ext }) => {
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const desc = MONTHS[month] || "æœªåˆ†ç±»";

      sortArr[month] = sortArr[month] || [];
      const len = sortArr[month].length + 1;
      sortArr[month].push(len);

      const fileName = `${month}æœˆ${day}æ—¥(${desc})-${sortArr[month].length}`;

      const newPath = toDir + fileName + ext; // 5æœˆ21æ—¥(521&å—äº¬)-1.jpg

      // åˆ¤æ–­æ˜¯å¦è¿‡æ»¤å·²å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶
      if (fs.existsSync(newPath)) {
        console.log(currentPath, "å·²å­˜åœ¨", newPath);
      }
      // æ–‡ä»¶é‡å‘½å
      if (!isDebug) {
        fs.renameSync(currentPath, newPath);
      }

      return { fileName, date };
    })
  );

  console.log("result", result);
};

main("./origin_photos/", "./target_photos/", false);
```
