---
title: WebHookç»“åˆGitHub Actionä¸Codingå®ç°åšå®¢æŒç»­é›†æˆéƒ¨ç½²åˆ°ä¸ªäººæœåŠ¡å™¨
date: 2021-01-25 21:52:47
permalink: /pages/337720/
categories:
  - æ–‡ç« 
tags:
  - æœåŠ¡å™¨
---

![æµç¨‹å›¾](https://cdn.jsdelivr.net/gh/JS-banana/images/vuepress/webhook.png)

<!-- more -->

## å‰è¨€

### ä»€ä¹ˆæ˜¯`GitHub Action`ã€`GitHub Page`

- **Github Action** å¯ä»¥å¸®åŠ©æ‚¨è‡ªåŠ¨å®Œæˆè½¯ä»¶å¼€å‘å‘¨æœŸå†…çš„ä»»åŠ¡ï¼Œå®ƒæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œè€Œä¸”å·²ç»å’Œ`GitHub`æ·±åº¦æ•´åˆï¼Œå¯ä»¥è¿è¡Œå¾ˆå¤š`GitHub`äº‹ä»¶ï¼Œæœ€æ™®éçš„æ˜¯æ¨é€åˆ°`master`åˆ†æ”¯ã€‚ä½†æ˜¯`actions`å¹¶ä¸ä»…ä»…åªæ˜¯éƒ¨ç½²å’Œå‘å¸ƒï¼Œå®ƒä»¬éƒ½æ˜¯å®¹å™¨ï¼Œæ¯«ä¸å¤¸å¼ åœ°è¯´ä½ å¯ä»¥åšä»»ä½•äº‹æƒ… â€”â€” æœ‰ç€æ— å°½çš„å¯èƒ½æ€§ï¼ä½ å¯ä»¥ç”¨å®ƒä»¬å‹ç¼©åˆå¹¶`CSS`å’Œ`JavaScript`ï¼Œæœ‰äººåœ¨ä½ çš„é¡¹ç›®ä»“åº“é‡Œåˆ›å»º`issue`çš„æ—¶å€™å‘ä½ å‘é€ä¿¡æ¯ï¼Œä»¥åŠæ›´å¤šâ€¦â€¦æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚

- **GitHub Page** æ˜¯Githubæä¾›çš„ä¸€æ¬¾å…è´¹çš„~ï¼Œç”¨äºæ‰˜ç®¡ä¸ªäººçš„é™æ€ç½‘ç«™ï¼Œå¯ä»¥ç”¨å®ƒæ¥æ­å»ºç§äººåšå®¢ï¼Œä¹Ÿç®—æ˜¯çœå»äº†è´­ä¹°æœåŠ¡å™¨ã€åŸŸåç­‰ç­‰ä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œã€‚

  **è§„åˆ™**ï¼šå»ºç«‹ä¸€ä¸ªä»“åº“å‘½åä¸º `ç”¨æˆ·å.github.io` ï¼Œ[å®˜æ–¹æ–‡æ¡£](https://docs.github.com/cn/github/working-with-github-pages/getting-started-with-github-pages)

  **ä½¿ç”¨**ï¼šä»“åº“ä¸‹åˆ›å»ºä¸€ä¸ª`index.html`æ–‡ä»¶è®¿é—®ç½‘å€å³å¯å¿«é€ŸæŸ¥çœ‹

### ä»€ä¹ˆæ˜¯`Coding`

- **CODING** ç³»è…¾è®¯æ——ä¸‹å…¨èµ„å­å…¬å¸, æ——ä¸‹ä¸€ç«™å¼è½¯ä»¶ç ”å‘ç®¡ç†å¹³å°â€”CODINGï¼ˆ[https://coding.net/](https://coding.net/) ï¼‰æ˜¯ä¸€ç«™å¼è½¯ä»¶ç ”å‘ç®¡ç†åä½œå¹³å°ï¼Œæä¾› Git/SVN ä»£ç æ‰˜ç®¡ã€é¡¹ç›®ååŒã€æµ‹è¯•ç®¡ç†ã€åˆ¶å“åº“ã€CI/CD ç­‰ä¸€ç³»åˆ—åœ¨çº¿å·¥å…·ï¼Œå¸®åŠ©ç ”å‘å›¢é˜Ÿå¿«é€Ÿè½åœ°æ•æ·å¼€å‘ä¸ `DevOps` å¼€å‘æ–¹å¼ï¼Œæå‡ç ”å‘ç®¡ç†æ•ˆç‡ï¼Œå®ç°ç ”å‘æ•ˆèƒ½å‡çº§ã€‚

- **Coding** æƒ³åšçš„å°±æ˜¯å¸®åŠ©å¼€å‘è€…èƒ½å¤Ÿé«˜æ•ˆçš„åœ¨äº‘ç«¯å®Œæˆè½¯ä»¶å¼€å‘çš„å·¥ä½œã€‚ä»£ç æ‰˜ç®¡ï¼Œé¡¹ç›®ç®¡ç†ï¼Œæ¼”ç¤ºå¹³å°ï¼Œè´¨é‡ç®¡ç†ç­‰ç­‰éƒ½æ˜¯ä¸ºäº†å¸®åŠ©å¼€å‘è€…åœ¨äº‘ç«¯å®Œæˆä¸€ç³»åˆ—é«˜éš¾åº¦çš„è½¯ä»¶å¼€å‘åŠ¨ä½œã€‚ç»™å¼€å‘è€…æä¾›æè‡´çš„äº‘ç«¯å¼€å‘ä½“éªŒï¼Œå¼ºè°ƒçš„æ˜¯ç§æœ‰åº“ï¼Œå¼ºè°ƒå›¢é˜Ÿåä½œï¼Œå¼ºè°ƒæ•´åˆä½“éªŒï¼Œå¼ºè°ƒè®¿é—®é€Ÿåº¦ã€‚

- **ä¸ºä»€ä¹ˆè¦ç”¨Coding**ï¼Ÿ

> å¯¹äºCodingçš„ä½œç”¨ï¼Œå…¶å®å°±ç±»ä¼¼Giteeä¸€æ ·ï¼Œå±äºå›½å†…éƒ¨ç½²ï¼Œé€Ÿåº¦æå‡éå¸¸æ˜æ˜¾ï¼Œè€Œä¸”è¿˜å¯ä»¥è¢«ç™¾åº¦æ”¶å½•ã€‚ç”±äºä¼—è¯´å‘¨çŸ¥çš„åŸå› ï¼Œå›½å†…è®¿é—®GitHubé€Ÿåº¦æ„Ÿäººï¼Œæˆ‘ä¹Ÿè¯•è¿‡ä¸€å¼€å§‹ç›´æ¥è·å–GitHubçš„ä»£ç ï¼Œä½†æ˜¯é€Ÿåº¦å¤ªæ…¢ï¼Œæ•ˆç‡å¾ˆä½ï¼Œå› æ­¤æœ€ç»ˆé€‰æ‹©äº†Codingä½œä¸ºä»“åº“é•œåƒï¼Œå½“ç„¶è¿™é‡Œæ¢æˆGiteeä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

### ä»€ä¹ˆæ˜¯`Webhook`

- **Webhook**æ˜¯ä¸€ä¸ª`API`æ¦‚å¿µï¼Œæœ¯è¯­â€œç½‘ç»œé’©å­â€ï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºâ€œåå‘ APIâ€ã€‚å› ä¸ºä»–æä¾›äº†APIè§„åˆ™ï¼Œä½ éœ€è¦è®¾è®¡è¦ä½¿ç”¨çš„`API`ã€‚`Webhook`å°†å‘ä½ çš„åº”ç”¨å‘èµ·`http`è¯·æ±‚ï¼Œå…¸å‹çš„æ˜¯`post`è¯·æ±‚ï¼Œåº”ç”¨ç¨‹åºç”±è¯·æ±‚é©±åŠ¨ã€‚æˆ‘ä»¬èƒ½ç”¨äº‹ä»¶æè¿°çš„äº‹ç‰©è¶Šå¤šï¼Œ`webhook`çš„ä½œç”¨èŒƒå›´ä¹Ÿå°±è¶Šå¤§ã€‚

- å‡†ç¡®çš„è¯´`webhook`æ˜¯ä¸€ç§webå›è°ƒæˆ–è€…httpçš„`push API`ï¼Œæ˜¯å‘APPæˆ–è€…å…¶ä»–åº”ç”¨æä¾›å®æ—¶ä¿¡æ¯çš„ä¸€ç§æ–¹å¼ã€‚`Webhook`åœ¨æ•°æ®äº§ç”Ÿæ—¶ç«‹å³å‘é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä½ èƒ½å®æ—¶æ”¶åˆ°æ•°æ®ã€‚ä½¿ç”¨ `webhooks`ï¼Œæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šå‘ç”ŸæŸäº›äº‹ä»¶æ—¶è·å¾—æ¨é€é€šçŸ¥ã€‚ä½ å¯ä»¥ä½¿ç”¨ webhooksâ€œè®¢é˜…â€æ´»åŠ¨ã€‚

## éœ€æ±‚åŠåœºæ™¯

ä¼—æ‰€å‘¨çŸ¥ï¼Œ`GitHub`ä½œä¸ºå…¨çƒæœ€å¤§åŒæ€§äº¤å‹ç¤¾åŒºï¼Œä¸ºäº†ä¸å¤§å®¶æ›´æ–¹ä¾¿å‹å¥½ç§¯æçš„äº¤æµ ğŸ¶ï¼Œæˆ‘çš„æºç å­˜æ”¾åœ°å€æ˜¯å­˜æ”¾åœ¨`GitHub`çš„ï¼Œå†…å®¹åŒ…æ‹¬åšå®¢çš„æ›´æ–°ã€ä¸€äº›æµ‹è¯•ç”¨ä¾‹ã€æ•™ç¨‹ã€Demoç­‰ã€‚

å› ä¸ºæˆ‘çš„åšå®¢æ˜¯éƒ¨ç½²åœ¨é˜¿é‡Œäº‘çš„ä¸ªäººæœåŠ¡å™¨ä¸Šï¼Œæœ‰æ—¶åšå®¢æ›´æ–°åˆæ¯”è¾ƒé¢‘ç¹ï¼Œä¸€å¼€å§‹æ˜¯é€šè¿‡sshé“¾æ¥åˆ°æœåŠ¡å™¨åç„¶åé€šè¿‡å‘½ä»¤`git clone`ã€`git pull`ã€`npm run build` è¿™ç§æ“ä½œæ–¹æ³•å»æ‰‹åŠ¨è¿›è¡Œæ›´æ–°ï¼Œè¿™é‡Œå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š

1. é¢‘ç¹ç™»å½•æœåŠ¡å™¨ï¼Œéå¸¸ç¹ç
2. `GitHub` é€Ÿåº¦é—®é¢˜ï¼Œæ¯æ¬¡æ›´æ–°éƒ½è¦ç­‰å¾…å¾ˆä¹…
3. æœåŠ¡å™¨æ€§èƒ½é—®é¢˜ï¼Œå¯¹äºä½é…æœåŠ¡å™¨æ‰§è¡Œ `npm run build` æ‰“åŒ…å¾ˆåƒåŠ›

## æ€è·¯åŠæµç¨‹å›¾

### æ€è·¯

1. æœ¬åœ°ç”µè„‘é€šè¿‡`git`æäº¤åˆ°`GitHub`ä»“åº“
2. `GitHub Action`ç›‘å¬åˆ°`push event`äº‹ä»¶è§¦å‘`ci.yml`æ‰§è¡Œè„šæœ¬
3. `build`æ‰“åŒ…ç”Ÿæˆéƒ¨ç½²æ–‡ä»¶æ¨é€åˆ°`GitHub gh-pages`åˆ†æ”¯ä¸`Coding master`åˆ†æ”¯
4. `Coding`è®¾ç½®`webhook`ç›‘å¬`push event`äº‹ä»¶è§¦å‘`webhook`é’©å­
5. `webhook`é’©å­é€šä¿¡åˆ°ä¸ªäººæœåŠ¡å™¨å†…å¯åŠ¨çš„`http server`ï¼ŒéªŒè¯èº«ä»½ä¸ä»“åº“ï¼Œæ‰§è¡Œ`webhook.sh`è„šæœ¬
6. `webhook.sh`è„šæœ¬`cd`è¿›å…¥`nginx`ä¸‹çš„åšå®¢éƒ¨ç½²ç›®å½•ï¼Œè¿›è¡Œ`git pull`æ›´æ–°æ“ä½œ
7. æ ¹æ®ç»“æœç”Ÿæˆæ—¥å¿—ï¼Œæˆ–æ·»åŠ é‚®ä»¶é€šçŸ¥åŠŸèƒ½ï¼ˆç»“åˆ`Nodemailer`åº“å®ç°ï¼‰

### æµç¨‹å›¾

![æµç¨‹å›¾](https://cdn.jsdelivr.net/gh/JS-banana/images/vuepress/webhook.png)

## åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œ Access Token

æ¥ä¸‹æ¥è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸æŒç»­é›†æˆä¼šç”¨åˆ°ä»¥`https`æ–¹å¼æäº¤ä»£ç åˆ°ä»“åº“çš„æ–¹æ¡ˆï¼Œè¿™é‡Œéœ€è¦é…ç½®ä¸‹`access token`ä¸ªäººè®¿é—®ä»¤ç‰Œä½œä¸ºç¯å¢ƒå˜é‡æä¾›ç»™`Action`ä¸è„šæœ¬ä½¿ç”¨ã€‚

### GitHub Token

ç¬¬ä¸€æ­¥ï¼ŒæŒ‰ç…§[å®˜æ–¹æ–‡æ¡£](https://docs.github.com/cn/github/authenticating-to-github/creating-a-personal-access-token) ï¼Œç”Ÿæˆä¸€ä¸ª`github token` (ä»¤ç‰Œ)ã€‚

ç¬¬äºŒæ­¥ï¼Œå°†è¿™ä¸ªå¯†é’¥å‚¨å­˜åˆ°å½“å‰ä»“åº“çš„`Settings/Secrets`é‡Œé¢ã€‚

> Settings/Secretsæ˜¯å‚¨å­˜ç§å¯†çš„ç¯å¢ƒå˜é‡çš„åœ°æ–¹ã€‚ç¯å¢ƒå˜é‡çš„åå­—å¯ä»¥éšä¾¿èµ·ï¼Œè¿™é‡Œç”¨çš„æ˜¯ACCESS_TOKENã€‚å¦‚æœä½ ä¸ç”¨è¿™ä¸ªåå­—ï¼Œ.github/workflows/ci.ymlè„šæœ¬é‡Œçš„å˜é‡åä¹Ÿè¦è·Ÿç€æ”¹ã€‚

### Coding Token

ç¬¬ä¸€æ­¥ï¼ŒæŒ‰ç…§[å®˜æ–¹æ–‡æ¡£](https://help.coding.net/docs/member/tokens.html) ï¼Œç”Ÿæˆä¸€ä¸ª`coding token` (ä»¤ç‰Œ)ã€‚

ç¬¬äºŒæ­¥ï¼ŒåŒ GitHub

## å‡ ç§æ–¹æ¡ˆ

:::tip
è¿™é‡Œç¤ºä¾‹å‡ ç§æˆ‘å°è¯•è¿‡çš„æ–¹æ¡ˆï¼Œä¸‹é¢ä¼šä»”ç»†åˆ†æä»‹ç»æ¯ç§æ–¹æ¡ˆçš„ä¼˜åŠ£ï¼Œä»¥åŠæˆ‘é€æ¸æ”¹è¿›ä¸å°è¯•çš„æ–¹æ³•ï¼Œå’Œæœ€ç»ˆå®ç°ã€‚
:::

### scp å‘½ä»¤ç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨

#### ä¸»è¦æ€è·¯

é€šè¿‡ä½¿ç”¨`scp`å‘½ä»¤ç›´æ¥æŠŠæœ¬åœ°éƒ¨ç½²æ–‡ä»¶æ‹·è´è‡³è¿œç¨‹æœåŠ¡å™¨

> `scp`æ˜¯`secure copy`çš„ç®€å†™ï¼Œæ˜¯ `linux` ç³»ç»Ÿä¸‹åŸºäº `ssh` ç™»é™†è¿›è¡Œå®‰å…¨çš„è¿œç¨‹æ–‡ä»¶æ‹·è´å‘½ä»¤ï¼Œ`scp`ä¼ è¾“æ˜¯åŠ å¯†çš„ã€‚

1. æœ¬åœ°è¿›è¡Œ`npm run build`æ‰“åŒ…ç¼–è¯‘ï¼Œè·å¾—éƒ¨ç½²æ–‡ä»¶

2. ç›´æ¥é€šè¿‡ä¸Šä¼ æ›¿æ¢æºæ–‡ä»¶è¿›è¡Œæ›´æ–°

    ```bash
    # 1. è¯¥å‘½ä»¤ä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„distæ–‡ä»¶éå†ä¸Šä¼ åˆ°blogç›®å½•ä¸‹ï¼š/blog/dist
    scp -r ./dist root@ip/usr/local/app/blog/
    # 2. è¾“å…¥æœåŠ¡å™¨å¯†ç ï¼Œç­‰å¾…ä¼ è¾“å®Œæˆå³å¯
    # å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡sshçš„æ–¹å¼æ— å¯†ç ä¸Šä¼ ï¼Œä½†è¿™å¹¶ä¸èƒ½è¾¾åˆ°æˆ‘çš„æœ€ç»ˆç›®çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°
    ```

#### æœ€ç»ˆæ•ˆæœ

- [x] æœåŠ¡å™¨ç¼–è¯‘çš„æ€§èƒ½é—®é¢˜å·²è§£å†³
- [x] GitHubæ›´æ–°æ‹‰å–é€Ÿåº¦æ…¢çš„é—®é¢˜å·²è§£å†³
- [ ] æ¯æ¬¡æ›´æ–°æ‰§è¡Œæ‰“åŒ…ç¼–è¯‘ã€ç™»å½•æ“ä½œç­‰æ­¥éª¤ä¾æ—§ç¹ç

### GitHub Action Pages

#### ä¸»è¦æ€è·¯

é€šè¿‡ä½¿ç”¨`GitHub`æä¾›çš„`Page` ä¸ `Action`æœåŠ¡å®ç°`gh-pages`æŒç»­é›†æˆä¸éƒ¨ç½²

> gh-pages çš„æ­å»ºæ•™ç¨‹ç½‘ä¸Šå¾ˆå¤šï¼Œå…·ä½“å®ç°æˆ‘å°±ä¸å†é‡å¤äº†ã€‚
> è¿™é‡Œæˆ‘æä¾›ä¸€ç§æˆ‘çš„æ–¹æ¡ˆï¼š

é€šè¿‡åŠ¨æ€ç”Ÿæˆ`gh-pages`åˆ†æ”¯å¹¶æ¨é€åˆ°githubä»“åº“å®ç°å¤šåœ°å€éƒ¨ç½²

å¦‚æˆ‘çš„åšå®¢çš„`GitHub`åœ°å€ï¼š[https://JS-banana.github.io/vuepress](https://JS-banana.github.io/vuepress)

#### è„šæœ¬ç¼–å†™

1. æ ¹ç›®å½•ä¸‹åˆ›å»º `.github>workflows>ci.yml`
2. ci.ymlæ–‡ä»¶

    ```yml
    jobs: # å·¥ä½œæµ
      build: # è‡ªå®šä¹‰åç§°
      runs-on: ubuntu-latest #è¿è¡Œåœ¨è™šæ‹Ÿæœºç¯å¢ƒubuntu-latest

      strategy:
        matrix:
        node-version: [14.x]

      steps: # æ­¥éª¤
        - name: Checkout # æ­¥éª¤1
        uses: actions/checkout@v1 # ä½¿ç”¨çš„åŠ¨ä½œã€‚æ ¼å¼ï¼šuserName/repoNameã€‚
        #ä½œç”¨ï¼šæ£€å‡ºä»“åº“ï¼Œè·å–æºç ã€‚ å®˜æ–¹actionsåº“ï¼šhttps://github.com/actions
        - name: Use Node.js ${{ matrix.node-version }} # æ­¥éª¤2
        uses: actions/setup-node@v1 # ä½œç”¨ï¼šå®‰è£…nodejs
        with:
          node-version: ${{ matrix.node-version }} # ç‰ˆæœ¬
        - name: Deploy # æ­¥éª¤3 éƒ¨ç½²åˆ°github gh-pages
        env: # è®¾ç½®ç¯å¢ƒå˜é‡
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # tokenç§å¯†å˜é‡
        run: |
          npm install
          npm run build
          cd ./dist
          git init
          git config user.name "name"
          git config user.email "email"
          git add .
          git commit -m "$(date) Update from Action"
          git push --force --quiet "https://JS-banana:${GITHUB_TOKEN}@github.com/JS-banana/vuepress.git" master:gh-pages
    ```

    > è¯¥pageé¡¹ç›®å¯ä»¥ä½œä¸ºå¤‡é€‰åœ°å€ä½¿ç”¨ï¼Œé€šè¿‡`CNAME`å®šå‘åˆ°æˆ‘ä»¬è‡ªå·±çš„åŸŸåæœåŠ¡å™¨ä¸‹ã€‚
    > **CNAME**ï¼šå³åˆ«åè®°å½•ã€‚è¿™ç§è®°å½•å…è®¸æ‚¨å°†å¤šä¸ªåå­—æ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªåŸŸåã€‚

3. æ‰§è¡Œ `echo 'ssscode.com' > CNAME` å‘½ä»¤ï¼Œç”Ÿæˆ `CNAME` æ–‡ä»¶ï¼Œç„¶åæŠŠ`CNAME`æ–‡ä»¶æ”¾åˆ°ç”Ÿæˆçš„`dist`ç›®å½•ä¸‹ï¼Œè¿™ä¸€æ­¥å¯ä»¥é€šè¿‡`bash`è„šæœ¬å¤„ç†

4. æˆ‘ä»¬å†æŠŠä¸Šé¢çš„è„šæœ¬è°ƒæ•´ä¸‹

    ```yml
    jobs: # å·¥ä½œæµ
      build: # è‡ªå®šä¹‰åç§°
      runs-on: ubuntu-latest #è¿è¡Œåœ¨è™šæ‹Ÿæœºç¯å¢ƒubuntu-latest

      strategy:
        matrix:
        node-version: [14.x]

      steps: # æ­¥éª¤
        - name: Checkout # æ­¥éª¤1
        uses: actions/checkout@v1 # ä½¿ç”¨çš„åŠ¨ä½œã€‚æ ¼å¼ï¼šuserName/repoNameã€‚
        #ä½œç”¨ï¼šæ£€å‡ºä»“åº“ï¼Œè·å–æºç ã€‚ å®˜æ–¹actionsåº“ï¼šhttps://github.com/actions
        - name: Use Node.js ${{ matrix.node-version }} # æ­¥éª¤2
        uses: actions/setup-node@v1 # ä½œç”¨ï¼šå®‰è£…nodejs
        with:
          node-version: ${{ matrix.node-version }} # ç‰ˆæœ¬
        - name: Deploy # æ­¥éª¤3 éƒ¨ç½²åˆ°github gh-pages
        env: # è®¾ç½®ç¯å¢ƒå˜é‡
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # tokenç§å¯†å˜é‡
        run: npm install && npm run deploy
    ```

5. åˆ›å»º`deploy.sh`æ–‡ä»¶,å¹¶åœ¨`package.json`å­—æ®µ`scripts`ä¸‹æ·»åŠ `"deploy": "bash deploy.sh"`å‘½ä»¤

    ```sh
    #!/usr/bin/env sh

    # ç¡®ä¿è„šæœ¬æŠ›å‡ºé‡åˆ°çš„é”™è¯¯
    set -e

    # date
    nowDate=$(date "+%Y-%m-%d %H:%M:%S")

    # ç”Ÿæˆé™æ€æ–‡ä»¶
    npm run build

    # è¿›å…¥ç”Ÿæˆçš„æ–‡ä»¶å¤¹
    cd ./dist
    
    # CNAME
    echo 'www.ssscode.com\ssscode.com' > CNAME  # è‡ªå®šä¹‰åŸŸå

    # github url
    githubUrl=https://JS-banana:${GITHUB_TOKEN}@github.com/JS-banana/vuepress.git

    # é…ç½® git ç”¨æˆ·ä¿¡æ¯
    git config --global user.name "JS-banana"
    git config --global user.email "sss213018@163.com"

    # commit
    git init
    git add -A
    git commit -m "deploy.sh===>updateï¼š${nowDate}"
    git push -f $githubUrl master:gh-pages # æ¨é€åˆ°github

    cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•
    rm -rf ./dist
    ```

- åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆé€šè¿‡GitHub Actionå®ç°æŒç»­é›†æˆï¼Œæ‰“åŒ…ç”Ÿæˆéƒ¨ç½²æ–‡ä»¶å¹¶æ¨é€åˆ°gh-pagesåˆ†æ”¯ã€‚

### Codingä¸GitHubåŒæ­¥éƒ¨ç½²

è¿™ä¸€æ­¥å…¶å®åŸç†å’Œä¸Šé¢**GitHub Action Pages**åšæ³•ä¸€æ ·ï¼Œè€Œæˆ‘ä»¬è¦åšçš„æœ€é‡è¦çš„ä¸€æ­¥ï¼Œå°±æ˜¯æŠŠ**Coding**çš„`token`ä¹Ÿé…ç½®åˆ°GitHubä»“åº“ä¸‹çš„`Settings/Secrets`é‡Œé¢ã€‚å³æ–°å¢ä¸€ä¸ªç¯å¢ƒå˜é‡`CODING_TOKEN`ï¼Œè¯¥æ–¹æ³•åŒæ ·é€‚ç”¨äº**Gitee**,æƒ³è¦ä½¿ç”¨Giteeçš„å°ä¼™ä¼´ä¹Ÿå¯ä»¥äº²è‡ªå°è¯•ã€‚

`ci.yml`æ–‡ä»¶å¢åŠ 

```diff
env: # è®¾ç½®ç¯å¢ƒå˜é‡
  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # github token ç§å¯†å˜é‡
+ CODING_TOKEN: ${{ secrets.CODING_TOKEN }} # coding token ç§å¯†å˜é‡
```

`deploy.sh`æ–‡ä»¶è°ƒæ•´ä¸º

```diff
  # github url
  githubUrl=https://JS-banana:${GITHUB_TOKEN}@github.com/JS-banana/vuepress.git

+ # coding url
+ #æ³¨æ„ï¼ï¼ï¼è¿™é‡Œéœ€è¦ä½¿ç”¨codingæä¾›çš„ä¸ªäººä»¤ç‰Œçš„ç”¨æˆ·åå’Œtoken ï¼ˆhttps://[name]:[token]@e.coding.net/xxï¼‰
+ codingUrl=https://ptzv1yuleer1:${CODING_TOKEN}@e.coding.net/ssscode/blog/vuepress.git 

  git push -f $githubUrl master:gh-pages # æ¨é€åˆ°github

- cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•
- rm -rf ./dist
  
+ git push -f $codingUrl master # æ¨é€åˆ°coding

+ cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•
+ rm -rf ./dist
```

## Webhookä¸Codingå®ç°æŒç»­éƒ¨ç½²

### å®ç°æ€è·¯

é¦–å…ˆï¼Œå®ç°ä¸€ä¸ª `nodejs http server`ç”¨äºæ¥æ”¶è¯·æ±‚ï¼Œå³ `webhook.js`é’©å­æœåŠ¡ï¼Œè¿™é‡Œæˆ‘å»ºè®®åŸŸåè§£æä¸€ä¸ªäºŒçº§åŸŸåä¾›webhookä¸“é—¨ä½¿ç”¨ï¼Œå¦‚ï¼š`webhook.ssscode.com`ï¼Œå½“ç„¶ï¼Œç›´æ¥åœ¨å½“å‰é¡¹ç›®ä¸‹ä»¥ `/webhook` è·¯å¾„ä½œä¸ºè§¦å‘è·¯ç”±ä¹Ÿå¯ä»¥ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ç¬¬ä¸€ç§æ–¹æ¡ˆä¸ºä¾‹ï¼Œä½¿ç”¨`nodejs`çš„`pm2`å®ˆæŠ¤ç¨‹åºå¯åŠ¨`webhook.js`ï¼Œç„¶åå†é€šè¿‡nginxåå‘ä»£ç†æœ¬åœ°å¯åŠ¨çš„æœåŠ¡æ˜ å°„åˆ° `webhook.ssscode.com` å³å¯ã€‚

### åˆ›å»º webhook.js

ä¸»è¦ä½¿ç”¨äº†NodeJsæ¨¡å—`http`ï¼ˆåˆ›å»ºserverï¼‰ ä¸ `child_process` ï¼ˆæ‰§è¡Œbashè„šæœ¬ï¼‰

åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç 

```js
// webhook.js
const server = require('http');
const { spawn } = require('child_process');

server
  .createServer((req, res) => {
    // accept request
    console.log(`accept requestï¼š${new Date()}`);
    // æ¥æ”¶POSTè¯·æ±‚
    if (req.method === 'POST') {
      //TODO: secret éªŒè¯

      let data = '';

      req.on('data', chunk => {
        data += chunk;
      });

      req.on('end', () => {
        // console.log(JSON.parse(data));
        try {
          const reqData = JSON.parse(data);
          // ç¡®å®šèº«ä»½
          if (reqData.pusher.username !== 'xxx') { // coding ä¸ªäººè®¿é—®ä»¤ç‰Œ Access Token ç”¨æˆ·å
            res.writeHead(400);
            res.end('noooo!');
            return;
          }
          // ç¡®å®šåˆ†æ”¯ master
          if (reqData.ref === 'refs/heads/master') {
            // ç¡®å®šä»“åº“
            const repository_name = reqData.repository.name;
            runCommand('sh', [`${repository_name}.sh`], console.log);
          }
          // response
          res.writeHead(200);
          res.end('ok');
        } catch (error) {
          console.log('errorï¼š', error);
          res.writeHead(500);
          res.end('error!');
        }
      });
    } else {
      res.writeHead(404);
      res.end('no info!');
    }
  })
  .listen(3010); // ç«¯å£

// run command
function runCommand(cmd, args, callback) {
  let response = '';
  const child = spawn(cmd, args);
  child.stdout.on('data', buffer => {
    response += buffer.toString();
  });
  child.stdout.on('end', () => callback(response));
}
```

æ ¸å¿ƒä»£ç æ˜¯ `runCommand` å‡½æ•°ï¼ŒserveræœåŠ¡æ¥æ”¶è¯·æ±‚å‚æ•°éªŒè¯èº«ä»½ä¸ä»“åº“ä¿¡æ¯ï¼Œæ»¡è¶³æ¡ä»¶æ‰§è¡Œå¯¹åº”è„šæœ¬ã€‚è¿™é‡Œæ²¡æœ‰åƒ `github-webhook-handler` åŒ…ä¸€æ ·å¯¹å¯†åŒ™è¿›è¡Œå¤„ç†éªŒè¯ï¼Œåªæ˜¯ç®€å•çš„éªŒè¯äº†èº«ä»½å’Œæ¡ä»¶ã€‚ï¼ˆgithubã€codingç­‰é…ç½®webhookæ—¶å¯ä»¥è®¾ç½®éªŒè¯ç§˜é’¥ï¼‰

æ¥ä¸‹æ¥ç¼–å†™æˆ‘ä»¬çš„bashè„šæœ¬ï¼Œè¿™é‡Œä¹‹åå¯ä»¥ä¼˜åŒ–æˆæ‰§è¡Œå¯¹åº”é¡¹ç›®ä¸‹çš„å¯¹åº”è„šæœ¬ï¼ˆå³ å¦‚æœå­˜åœ¨å¤šä¸ªé¡¹ç›®æˆ–åšå®¢ï¼Œç›¸å…³è„šæœ¬åœ¨å¯¹åº”é¡¹ç›®ä¸‹åˆ›å»ºï¼Œç”±bashæ‰§è¡Œï¼‰ã€‚

### åˆ›å»ºbashè„šæœ¬

`vuepress.sh`æ ¸å¿ƒä»£ç 

```sh
#!/usr/bin/env sh
# ç¡®ä¿è„šæœ¬æŠ›å‡ºé‡åˆ°çš„é”™è¯¯
set -e

cd /usr/local/app/vuepress-blog/dist

echo 'start===>git'

# è¦†ç›–æ›´æ–°
git fetch --all
git reset --hard origin/master
# git clean -f
# git pull

cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•
```

ä¸ºäº†æ–¹ä¾¿è®°å½•å’ŒæŸ¥çœ‹ä»¥åŠæ‹“å±•é€šçŸ¥æ¶ˆæ¯ç­‰ï¼Œè¿™é‡Œå¢åŠ å¼‚å¸¸åˆ¤æ–­å¤„ç†åŠæ—¥å¿—è¾“å‡º

```diff
- cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•

+ function log_info (){
+   DATE_N=`date "+%Y-%m-%d %H:%M:%S"`
+   USER_N=`whoami`
+   echo "${DATE_N} ${USER_N} execute $0 [INFO] $@" >> /usr/local/app/webhook/logInfo.txt #æ‰§è¡ŒæˆåŠŸæ—¥å¿—æ‰“å°è·¯å¾„
+ }

+ function log_error (){
+   DATE_N=`date "+%Y-%m-%d %H:%M:%S"`
+   USER_N=`whoami`
+   echo -e "\033[41;37m ${DATE_N} ${USER_N} execute $0 [ERROR] $@ \033[0m"  >> /usr/local/app/webhook/logError.txt #æ‰§è¡Œå¤±è´¥æ—¥å¿—æ‰“å°è·¯å¾„
+ }

+ if [  $? -eq 0  ]
+ then
+   log_info "$@ sucessed."
+   echo -e "\033[32m $@ sucessed. \033[0m"
+ else
+   log_error "$@ failed."
+   echo -e "\033[41;37m $@ failed. \033[0m"
+   exit 1
+ fi

+ trap 'fn_log "DO NOT SEND CTR + C WHEN EXECUTE SCRIPT !!!! "'  2

+ cd - # é€€å›å¼€å§‹æ‰€åœ¨ç›®å½•
```

### åˆ›å»ºnginxé…ç½®

nginxé…ç½®

```nginx
server {
  #å¤–ç½‘
  listen 80;
  server_name webhook.ssscode.com; #åŸŸå

  # ç›‘å¬æœ¬åœ°æœåŠ¡
  location / {
    # å¼€å¯åå‘ä»£ç†
    proxy_pass http://127.0.0.1:3010/;
  }
}
```

æ‰§è¡Œ `node ./webhook.js` å³å¯å¯åŠ¨æµ‹è¯•~

### pm2

> PM2 æ˜¯ node è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥ç®€åŒ–å¾ˆå¤š nodeåº”ç”¨ç®¡ç†çš„ç¹çä»»åŠ¡ï¼Œå¦‚æ€§èƒ½ç›‘æ§ã€è‡ªåŠ¨é‡å¯ã€è´Ÿè½½å‡è¡¡ç­‰ï¼Œè€Œä¸”ä½¿ç”¨éå¸¸ç®€å•ã€‚[PM2ç®€æ˜“ä½¿ç”¨æ‰‹å†Œ](https://juejin.cn/post/6844903710037016584)

ä¸ºäº†æ›´æ–¹ä¾¿çš„ç®¡ç†NodeJsç¨‹åºä»¥åŠç›‘æ§ï¼Œè¿™é‡Œæ¨èä½¿ç”¨ `pm2 start webhook.js` å¯åŠ¨æœåŠ¡

### Githubæˆ–Giteeç»“åˆwebhook

å› ä¸ºæˆ‘é‡‡ç”¨çš„æ˜¯`Coding`ç»“åˆ`webhook`çš„æ–¹å¼ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´å¯¹å…¶ä»–æ–¹å¼æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œæ­å»ºï¼ŒåŸç†ç±»ä¼¼ï¼Œç›®å‰`Github`ä¸`Gitee`ä¹Ÿæœ‰å¼€æºçš„`npm`åŒ…æä¾›å¿«é€Ÿæ­å»ºwebhooké€šä¿¡æœåŠ¡ã€‚[github-webhook-handler](https://github.com/rvagg/github-webhook-handler)ã€[gitee-webhook-handler](https://github.com/CloudnuY/gitee-webhook-handler)

## ç»“è¯­

å¤§åŠŸå‘Šæˆ~

æ€»çš„æ¥è¯´å°±æ˜¯åå¤å°è¯•äº†å¾ˆå¤šæ–¹æ³•ï¼Œæ‘¸ç´¢æ‰¾æ€è·¯ï¼Œå†ä¸æ–­çš„æ”¹è¿›ï¼Œæœ€ç»ˆä¹Ÿæ˜¯å®ç°äº†å½“åˆçš„æƒ³æ³•ï¼Œä¸è¿‡ä¹Ÿç¡®å®èµ°äº†ä¸å°‘å¼¯è·¯ã€‚åœ¨æ­¤ï¼ŒæŠŠæ•´ä¸ªè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œä¾›è‡ªå·±å‚è€ƒä¹Ÿä¸ºäº†åŠ æ·±ç†è§£ï¼Œå¸Œæœ›èƒ½å¸®åˆ°æœ‰éœ€è¦çš„å°ä¼™ä¼´ï¼Œå°‘èµ°äº›å¼¯è·¯~

å¦‚æœè‡ªå·±å…¨éƒ¨é…ç½®å„ç§æœåŠ¡ä¸ä»£ç ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿç¡®å®æŒºèŠ±è´¹æ—¶é—´å’Œç²¾åŠ›çš„ï¼Œæ¶‰åŠçš„æŠ€æœ¯ç‚¹ä¹Ÿæ¯”è¾ƒæ‚ï¼Œå¾ˆå¤šåœ°æ–¹åªèƒ½è¾¾åˆ°å‹‰å¼ºä½¿ç”¨ï¼Œè¿˜å·®å¾—è¿œï¼Œæ•´ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯è¾¹å­¦ä¹ ä¾¿å°è¯•ã€‚ä¸è¿‡ï¼Œå…¨éƒ¨å¼„å®Œä¹‹åï¼Œå¯¹äºè‡ªå·±çš„æŠ€æœ¯æˆé•¿ä¸ä¸šåŠ¡ç†è§£ä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„~

ç±»ä¼¼Hexoè¿™æ ·çš„å¿«é€Ÿæ­å»ºåšå®¢çš„æ¡†æ¶ç”¨èµ·æ¥å€’æ˜¯å¯ä»¥çœä¸å°‘äº‹ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å°è¯•ä¸‹ï¼Œè¿™ä¸ªæˆ‘ä¹Ÿæœ‰åœ¨å¼„ï¼Œä¸è¿‡è¿˜æ²¡è¾¾åˆ°æˆ‘çš„é¢„æœŸæ•ˆæœï¼Œçœ‹çœ‹ä¹‹åæœ‰æ²¡æœ‰å¯å†™çš„ä¸œè¥¿å†åˆ†äº«åˆ†äº«å§

ä¹‹åå¯¹äºDockerä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦æ·±å…¥å­¦ä¹ ä¸€ç•ªäº†~

## 2021.06.08 è¡¥å……

ä½¿ç”¨ `Travis` ç»“åˆ `sshpass` å·¥å…·å®ç°æœ¬æœºæ–‡ä»¶ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚

.travis.yml

```yml
language: node_js
node_js:
  - 12
branchs:
  - master
addons:
  apt:
    packages:
    - sshpass
install:
  "npm install"
script:
  - "npm run build"
after_success:
  - ./deploy.sh
```

deploy.sh

```sh
#!/usr/bin/env sh

# ç¡®ä¿è„šæœ¬æŠ›å‡ºé‡åˆ°çš„é”™è¯¯
set -e

# æ‰“åŒ…é™æ€èµ„æº
npm run build

# å°†distæ–‡ä»¶å‘é€åˆ°è¿œç¨‹
sshpass -p ${serverPass} scp -o stricthostkeychecking=no -r dist/ root@${serverIP}:/home/web/movie-trailer
```

ä¼˜ç‚¹ï¼šæ–¹ä¾¿å¿«æ·

ç¼ºç‚¹ï¼šä½¿ç”¨ sshpass æ˜¯æœ€ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæ‰€æœ‰ç³»ç»Ÿä¸Šçš„ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸­é€šè¿‡ç®€å•çš„ â€œpsâ€ å‘½ä»¤å°±å¯çœ‹åˆ°å¯†ç ã€‚

## å‚è€ƒ

> <https://coding.net/>
>
> <https://docs.github.com/cn/actions>
>
> <https://xugaoyi.com/pages/6b9d359ec5aa5019/>
>
> <https://docs.github.com/cn/github/authenticating-to-github/creating-a-personal-access-token>
>
> <https://help.coding.net/docs/member/tokens.html>
>
> <https://ipcmen.com/>
>
> <http://www.ruanyifeng.com/blog/2016/07/yaml.html>
>
> <https://juejin.cn/post/6844903710037016584>
>
> <https://linux.cn/article-8086-1.html>
>
> <https://bbs.huaweicloud.com/blogs/152237>
