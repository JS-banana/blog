---
title: å‘å¸ƒè®¢é˜…æ¨¡å¼vsè§‚å¯Ÿè€…æ¨¡å¼
date: 2021-07-18 09:41:49
permalink: /pages/911929/
categories:
  - JavaScript
tags:
  - è®¾è®¡æ¨¡å¼
---

> æ˜é‡‘ï¼š[å‘å¸ƒè®¢é˜…æ¨¡å¼vsè§‚å¯Ÿè€…æ¨¡å¼](https://juejin.cn/post/6990952531761299487/)

## èƒŒæ™¯

æœ€è¿‘åœ¨ç ”ç©¶`react`çš„çŠ¶æ€ç®¡ç†å™¨`zustand`æ—¶ï¼Œç ”ç©¶æºç æ—¶å‘ç°å…¶ç»„ä»¶æ³¨å†Œç»‘å®šæ˜¯é€šè¿‡è§‚å¯Ÿè€…æ¨¡å¼ç»“åˆ`react hooks`å®ç°æ›´æ–°çš„ã€‚è€Œè”æƒ³ä¹‹å‰å†™`vue`çš„æ—¶å€™ï¼Œç»å¸¸ä¼šç”¨åˆ°`vue`å†…ç½®çš„è‡ªå®šä¹‰äº‹ä»¶è¿›è¡Œç»„ä»¶é€šä¿¡ï¼ˆ`$emit`/`on`ï¼‰ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œæå¾—æˆ‘æœ‰ç‚¹å¤´å¤§ï¼Œæ„Ÿè§‰è¿™ä¸¤ç§æ¨¡å¼åˆååˆ†ç›¸ä¼¼ï¼Œè‡ªå·±ä¹Ÿæ˜¯æœ‰ç‚¹è¿·ç³Šï¼Œæ„Ÿè§‰æ²¡æœ‰ç†è§£é€ï¼Œå› æ­¤ï¼Œè¿™æ¬¡å°±é¡ºåŠ¿æ·±å…¥ç ”ç©¶ä¸‹è¿™ä¸¤ç§æ¨¡å¼ï¼Œå†å°è¯•è‡ªå·±æ‰‹å†™å®ç°åŠ æ·±ä¸‹ç†è§£ã€‚è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä¸ªäººçš„æ¢³ç†å¿ƒå¾—ï¼Œå¦‚æœ‰é”™è¯¯æ¬¢è¿æŒ‡æ­£ï¼Œå…±åŒè¿›æ­¥~

<!-- more -->

## å¯¹æ¯”

### åŒºåˆ«

**è§‚å¯Ÿè€…æ¨¡å¼**ï¼šåœ¨è½¯ä»¶è®¾è®¡ä¸­æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç»´æŠ¤ä¸€ä¸ªä¾èµ–åˆ—è¡¨ï¼Œå½“ä»»ä½•çŠ¶æ€å‘ç”Ÿæ”¹å˜è‡ªåŠ¨é€šçŸ¥å®ƒä»¬ã€‚

**å‘å¸ƒ-è®¢é˜…è®¾è®¡æ¨¡å¼**ï¼šæ¶ˆæ¯çš„å‘é€æ–¹ï¼ˆå‘å¸ƒè€…ï¼‰ä¸ä¼šç›´æ¥å‘é€ç»™ç‰¹å®šçš„æ¥æ”¶è€…ï¼ˆå«åšè®¢é˜…è€…ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªä¿¡æ¯ä¸­ä»‹è¿›è¡Œè¿‡æ»¤å’Œåˆ†é…æ¶ˆæ¯ã€‚

é€šä¿—å½¢è±¡ç‚¹æ¥è¯´å°±æ˜¯ï¼š

- **å¯Ÿè€…æ¨¡å¼**æ²¡ä¸­é—´å•†èµšå·®ä»·ï¼Œ**å‘å¸ƒè®¢é˜…æ¨¡å¼** æœ‰ä¸­é—´å•†èµšå·®ä»·ã€‚
- **è§‚å¯Ÿè€…æ¨¡å¼**ä¸ºä¸€åˆ€åˆ‡æ¨¡å¼ï¼Œå¯¹æ‰€æœ‰è®¢é˜…è€…ä¸€è§†åŒä»ï¼Œ**å‘å¸ƒè®¢é˜…æ¨¡å¼**å¯ä»¥æˆ´æœ‰è‰²çœ¼é•œï¼Œæœ‰ä¸€å±‚è¿‡æ»¤æˆ–è€…è¯´æš—ç®±æ“ä½œã€‚

è´´å¼ å›¾å¤§å®¶æ„Ÿå—ä¸‹

![ä¾µåˆ ](https://user-gold-cdn.xitu.io/2017/11/22/15fe1b1f174cd376?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### æ€»ç»“ä¸€ä¸‹

- åœ¨**è§‚å¯Ÿè€…**æ¨¡å¼ä¸­ï¼Œè§‚å¯Ÿè€…æ˜¯çŸ¥é“*Subject*çš„ï¼Œ*Subject*ä¸€ç›´ä¿æŒå¯¹è§‚å¯Ÿè€…è¿›è¡Œè®°å½•ã€‚ç„¶è€Œï¼Œåœ¨**å‘å¸ƒè®¢é˜…**æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…**ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨**ã€‚å®ƒä»¬åªæœ‰é€šè¿‡æ¶ˆæ¯ä»£ç†è¿›è¡Œé€šä¿¡ã€‚

- åœ¨**å‘å¸ƒè®¢é˜…**æ¨¡å¼ä¸­ï¼Œç»„ä»¶æ˜¯æ¾æ•£è€¦åˆçš„ï¼Œæ­£å¥½å’Œè§‚å¯Ÿè€…æ¨¡å¼ç›¸åã€‚

- **è§‚å¯Ÿè€…æ¨¡å¼**å¤§å¤šæ•°æ—¶å€™æ˜¯**åŒæ­¥**çš„ï¼Œæ¯”å¦‚å½“äº‹ä»¶è§¦å‘ï¼ŒSubjectå°±ä¼šå»è°ƒç”¨è§‚å¯Ÿè€…çš„æ–¹æ³•ã€‚è€Œ**å‘å¸ƒ-è®¢é˜…**æ¨¡å¼å¤§å¤šæ•°æ—¶å€™æ˜¯**å¼‚æ­¥**çš„ï¼ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚

- **è§‚å¯Ÿè€…**æ¨¡å¼éœ€è¦åœ¨å•ä¸ªåº”ç”¨ç¨‹åºåœ°å€ç©ºé—´ä¸­å®ç°ï¼Œè€Œ**å‘å¸ƒ-è®¢é˜…**æ›´åƒäº¤å‰åº”ç”¨æ¨¡å¼ã€‚

> æ¦‚å¿µçœ‹ä¸Šå»ä¼¼ä¹ä¹ŸæŒºæ¸…æ™°çš„ï¼Œå®ƒä»¬ä¹‹é—´çš„å·®å¼‚ç‚¹ç­‰ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹è‡ªå·±åŠ¨æ‰‹å®ç°ï¼Œæ·±å…¥å…¶å†…éƒ¨åŸç†å’Œè¿è¡Œé€»è¾‘ã€‚

## å‘å¸ƒè®¢é˜…æ¨¡å¼

`vue`è‡ªå®šä¹‰äº‹ä»¶`Event Bus`å°±æ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼çš„å®ç°ï¼Œè¿˜æœ‰`Nodejs`çš„`Emitter Event`ã€‚

å®ç°ä¸€ä¸ªæ”¯æŒè®¢é˜…ã€è§£ç»‘ã€å‘å¸ƒã€åŒç±»å‹äº‹ä»¶æ”¯æŒå¤šæ¬¡ç»‘å®šçš„å‘å¸ƒè®¢é˜…ã€‚

### æ¥ä¸ªç®€å•å®ç°

ä¸Šä»£ç 

```js
// è®¢é˜…ä¸­å¿ƒ
const subscribers = {}
// è®¢é˜…
const subscribe = (type, fn) => {
  // ä»¥æ•°ç»„æ¨¡å¼æ·»åŠ é˜Ÿåˆ—ï¼Œåšåˆ°åŒä¸€ç±»å‹æ”¯æŒå¤šä¸ªç»‘å®š
  if (!subscribers[type]) subscribers[type] = []
  subscribers[type].push(fn)
}
// å‘å¸ƒ
const publish = (type, ...args) => {
  if (!subscribers[type] || !subscribers[type].length) return
  subscribers[type].forEach((fn) => fn(...args))
}
// è§£ç»‘è®¢é˜…
const unsubscribe = (type, fn) => {
  if (!subscribers[type] || !subscribers[type].length) return
  subscribers[type] = subscribers[type].filter((n) => n !== fn)
}
```

éªŒè¯æµ‹è¯•

```js
// console test ======>
subscribe("topic-1", () => console.log("suber-A è®¢é˜…äº† topic-1"))
subscribe("topic-2", () => console.log("suber-B è®¢é˜…äº† topic-2"))
subscribe("topic-1", () => console.log("suber-C è®¢é˜…äº† topic-1"))

publish("topic-1") // é€šçŸ¥è®¢é˜…äº† topic-1 çš„ A å’Œ C

// è¾“å‡ºç»“æœ
// suber-A è®¢é˜…äº† topic-1
// suber-C è®¢é˜…äº† topic-1
```

### å®ç°ä¸€ä¸ªEmitterç±»

ä¸Šä»£ç 

```js
class Emitter {
  constructor() {
    // è®¢é˜…ä¸­å¿ƒ
    this._event = this._event || {}
  }
  // æ³¨å†Œè®¢é˜…
  addEventListener(type, fn) {
    const handler = this._event[type]

    if (!handler) {
      this._event[type] = [fn]
    } else {
      handler.push(fn)
    }
  }
  // å¸è½½è®¢é˜…
  removeEventListener(type, fn) {
    const handler = this._event[type]

    if (handler && handler.length) {
      this._event[type] = handler.filter((n) => n !== fn)
    }
  }
  // é€šçŸ¥
  emit(type, ...args) {
    const handler = this._event[type]

    if (handler && handler.length) {
      handler.forEach((fn) => fn.apply(this, args))
    }
  }
}
```

éªŒè¯æµ‹è¯•

```js
// console test ======>
const emitter = new Emitter()

emitter.addEventListener("change", (obj) => console.log(`name is ${obj.name}`))

emitter.addEventListener("change", (obj) => console.log(`age is ${obj.age}`))

const sex = (obj) => console.log(`sex is ${obj.sex}`)

emitter.addEventListener("change", sex)

emitter.emit("change", { name: "xiaoming", age: 28, sex: "male" })

console.log("event-A", emitter._event)

emitter.removeEventListener("change", sex)

console.log("====>>>>")

emitter.emit("change", { name: "xiaoming", age: 28, sex: "male" })

console.log("event-B", emitter._event)

// è¾“å‡º
// name is xiaoming
// age is 28
// sex is male
// event-A {change: Array(3)}

// ====>>>>

// name is xiaoming
// age is 28
// event-B {change: Array(2)}
```

### vue Event Bus å®ç°

#### ç»“æ„æ¢³ç†

> æºç ä½ç½®ï¼š[src/core/instance/events.js](https://github.com/vuejs/vue/blob/dev/src/core/instance/events.js)

é¦–å…ˆæˆ‘ä»¬æ ¹æ®æºç åˆ†æä¸‹ç»“æ„ï¼Œæ¢³ç†ä¸€ä¸‹`vue`çš„`event`å®ç°é€»è¾‘

1. æŠŠäº‹ä»¶ä¸­å¿ƒ `_events` æŒ‚è½½åˆ° `Vue` å®ä¾‹ä¸Šï¼š

   `vm._events = {}`

2. æŠŠæ‰€æœ‰çš„æ–¹æ³•ï¼š `$on` ã€ `$once` ã€ `$off` ã€ `$emit` æŒ‚è½½åˆ°VueåŸå‹ä¸Š

  > è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥åœ¨Vueç»„ä»¶ä¸­ä½¿ç”¨æ—¶ç›´æ¥ `this.$on` ã€ `this.$emit`

   ```js
   // $on
   Vue.prototype.$on = function(){}
   // $once
   Vue.prototype.$once = function(){}
   // $once
   Vue.prototype.$off = function(){}
   // $once
   Vue.prototype.$emit = function(){}
   ```

#### çœ‹ä»£ç 

1. `$on` æ·»åŠ æ³¨å†Œ

    ```js
    // $on
    Vue.prototype.$on = function (event, fn) {
      const vm = this

      // å¦‚æœä¼ å…¥çš„ event ç›‘å¬äº‹ä»¶ç±»å‹ä¸ºæ•°ç»„ï¼Œé€’å½’è°ƒç”¨ $on æ–¹æ³•
      if (Array.isArray(event)) {
        for (let i = 0, l = event.length; i < l; i++) {
          vm.$on(event[i], fn)
        }
      } else {

        // å¦‚æœå­˜åœ¨ç›´æ¥æ·»åŠ ï¼Œä¸å­˜åœ¨æ–°å»ºåæ·»åŠ 
        ;(vm._events[event] || (vm._events[event] = [])).push(fn)
      }

      // è¿”å›thisï¼Œç”¨äºé“¾å¼è°ƒç”¨
      return vm
    }
    ```

2. `$once` å•æ¬¡æ‰§è¡Œ

    ```js
    // $once
    Vue.prototype.$once = function (event, fn) {
      const vm = this

      // å½“è¯¥ event äº‹ä»¶è§¦å‘æ—¶ï¼Œè°ƒç”¨ on æ–¹æ³•
      function on() {

        // é¦–å…ˆæ‰§è¡Œ $off æ–¹æ³•å¸è½½ æœ¬å›è°ƒæ–¹æ³•
        vm.$off(event, on)

        // å†æ‰§è¡Œ æœ¬å›è°ƒæ–¹æ³•
        fn.apply(vm, arguments)
      }

      // è¯¥èµ‹å€¼ä¼šåœ¨ $off ä¸­ä½¿ç”¨ï¼šcb.fn === fn
      // å› ä¸ºè¯¥ $once æ–¹æ³•è°ƒç”¨çš„æ˜¯ $on æ·»åŠ å›è°ƒï¼Œä½†æ˜¯æ·»åŠ çš„æ˜¯åŒ…è£…åçš„ on æ–¹æ³•è€Œä¸æ˜¯ fn æ–¹æ³•
      // å› æ­¤å½“æˆ‘ä»¬å•ç‹¬è°ƒç”¨ $offæ–¹æ³•åˆ é™¤ fn å›è°ƒæ—¶ï¼Œæ˜¯æ‰¾ä¸åˆ°çš„ï¼Œè¿™æ—¶å°±å¯ä»¥é€šè¿‡ cb.fn === fn åˆ¤æ–­
      on.fn = fn

      // è°ƒç”¨ $on æ–¹æ³•ï¼ŒæŠŠè¯¥å›è°ƒæ·»åŠ åˆ°é˜Ÿåˆ—
      vm.$on(event, on)

      return vm
    }
    ```

3. `$off` å¸è½½åˆ é™¤

    ```js
    // $off
    Vue.prototype.$off = function (event, fn) {
      const vm = this

      // å¦‚æœä¸ä¼ å…¥ä»»ä½•å‚æ•°ï¼Œæ¸…ç©ºæ‰€æœ‰çš„äº‹ä»¶
      if (!arguments.length) {
        vm._events = Object.create(null)
        return vm
      }

      // å¦‚æœ event ä¸ºæ•°ç»„ï¼ŒåŒ $on é€»è¾‘ï¼Œé€’å½’å¸è½½äº‹ä»¶
      if (Array.isArray(event)) {
        for (let i = 0, l = event.length; i < l; i++) {
          vm.$off(event[i], fn)
        }
        return vm
      }

      // å›è°ƒåˆ—è¡¨
      const cbs = vm._events[event]

      // å¦‚æœè¯¥ event äº‹ä»¶ä¸å­˜åœ¨ç»‘å®šå›è°ƒï¼Œä¸å¤„ç†
      if (!cbs) {
        return vm
      }

      // å¦‚æœæœªä¼ å…¥å¯¹åº” event çš„è§£ç»‘å›è°ƒï¼Œåˆ™æ¸…ç©ºè¯¥ event çš„æ‰€æœ‰
      if (!fn) {
        vm._events[event] = null
        return vm
      }

      // event äº‹ä»¶ç±»å‹å’Œ å›è°ƒ éƒ½å­˜åœ¨ï¼Œéå†æŸ¥æ‰¾åˆ é™¤ æŒ‡å®š å›è°ƒ
      let cb
      let i = cbs.length
      while (i--) {
        cb = cbs[i]
        if (cb === fn || cb.fn === fn) {
          cbs.splice(i, 1)
          break
        }
      }
      return vm
    }
    ```

4. `$emit` è§¦å‘äº‹ä»¶

    ```js
    // $emit
    Vue.prototype.$emit = function (event) {
      const vm = this

      // å›è°ƒåˆ—è¡¨
      let cbs = vm._events[event]

      // åˆ¤æ–­è¯¥ event æ˜¯å¦å­˜åœ¨æ‰§è¡Œå›è°ƒ
      if (cbs) {

        // $emitæ–¹æ³•å¯ä»¥ä¼ å‚ï¼Œè¿™äº›å‚æ•°ä¼šåœ¨è°ƒç”¨å›è°ƒå‡½æ•°çš„æ—¶å€™ä¼ è¿›å»
        // æ’é™¤ event å‚æ•°çš„å…¶ä»–å‚æ•°
        // toArray æ˜¯ä¸€ä¸ªæŠŠç±»æ•°ç»„è½¬æ¢ä¸ºæ•°ç»„çš„æ–¹æ³•ï¼Œå¹¶æ”¯æŒæˆªå–
        const args = toArray(arguments, 1)

        // éå†å›è°ƒå‡½æ•°
        for (let i = 0, l = cbs.length; i < l; i++) {
          cbs[i].apply(vm, args)
        }
      }
      return vm
    }
    ```

    <details><summary> toArrayæ–¹æ³• </summary>

      ```js
      // Convert an Array-like object to a real Array.
      function toArray (list, start) {
        start = start || 0;
        var i = list.length - start;
        var ret = new Array(i);
        while (i--) {
          ret[i] = list[i + start];
        }
        return ret
      }
      ```

    </details>

#### æµ‹è¯•ä¸‹

æˆ‘ä»¬å…ˆæ¨¡æ‹Ÿä¸€ä¸ªVueç±»æµ‹è¯•ä¸‹

```js
class Vue {
  constructor() {
    this._events = {}
  }

  // æä¾›ä¸€ä¸ªå¯¹å¤–è·å– _events çš„æ¥å£
  get event() {
    return this._events
  }
}
```

éªŒè¯ä¸‹ç»“æœ

```js
// å®ä¾‹åŒ–
const myVue = new Vue()

// æ·»åŠ è®¢é˜…
const update_user = (args) => console.log("userï¼š", args)
const once_update_user = (args) => console.log("once_userï¼š", args)

myVue.$on("user", update_user)
myVue.$once("user", once_update_user) // è¯¥è®¢é˜…è§¦å‘åè‡ªåŠ¨å¸è½½

// è¾“å‡ºæ‰“å°
console.log("eventsï¼š", myVue.event)
// eventsï¼š {user: [(args) => console.log("userï¼š", args), Æ’ on()]}

// è§¦å‘é€šçŸ¥
myVue.$emit("user", { name: "xiaoming", age: 18 })
console.log("eventsï¼š", myVue.event)
// eventsï¼š {user: [(args) => console.log("userï¼š", args)]}
// userï¼š {name: "xiaoming", age: 18}
// once_userï¼š {name: "xiaoming", age: 18}

// å¸è½½è®¢é˜…
myVue.$off("user", once_update_user)
console.log("eventsï¼š", myVue.event)
// eventsï¼š{user: []}
```

### å°æ€»ç»“ä¸‹

`Vue` å°è£…çš„è¿™ä¸ªå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆå®Œå–„äº†ï¼Œè¿™ä¸ªæ˜¯å®Œå…¨å¯ä»¥ç‹¬ç«‹æŠ½å–å‡ºæ¥çš„åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨çš„ä»£ç ï¼Œå†æ ¹æ®è‡ªèº«éœ€æ±‚ï¼Œè°ƒæ•´ä¸‹äº‹ä»¶å­˜å‚¨å™¨çš„ä½ç½®å³å¯ï¼ˆ`Vue` æ”¾åœ¨äº†å®ä¾‹ä¸Šï¼‰ã€‚

æˆ‘ä»¬ä»æœ€ç®€å•çš„å‡ è¡Œä»£ç ï¼Œä¸€ç›´åˆ°æ¡†æ¶ä¸­çš„ç»†è‡´å®Œæ•´å®ç°ï¼Œä»ä¸­å¯ä»¥å‘ç°ï¼šå…¶å®åªè¦æˆ‘ä»¬æ€è·¯å¯¹äº†ï¼Œæ ¸å¿ƒæ–¹æ³•æŒæ¡ç†è§£äº†ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å¼„æ˜ç™½å…¶å®ç°åŸç†ï¼Œè€Œå‰©ä¸‹çš„å¤§å¤šéƒ½æ˜¯å¯¹å„ç§å¼‚å¸¸æƒ…å†µçš„åˆ¤æ–­å’Œå¤„ç†ã€‚

## è§‚å¯Ÿè€…æ¨¡å¼

åªè¦å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚

### ä¹Ÿæ¥ä¸ªç®€å•å®ç°

```js
// è§‚å¯Ÿè€…åˆ—è¡¨
const observers = []

// æ·»åŠ 
const addob = (ober) => {
  observers.push(ober)
}

// é€šçŸ¥
const notify = (...args) => {
  observers.forEach((fn) => fn(args))
}

// æµ‹è¯• =======>
const subA = () => console.log("I am sub A")
const subB = (args) => console.log("I am sub B", args)

addob(subA)
addob(subB)
notify({ name: "sss", site: "ssscode.com" })
// I am sub A
// I am sub B [{name: "sss", site: "ssscode.com"}]
```

### å®ç°ä¸€ä¸ªè§‚å¯Ÿè€…ç±»

ä¸Šä»£ç 

```js
// è§‚å¯Ÿè€…
class Observer {
  constructor(name) {
    // è§‚å¯Ÿè€… name
    this.name = name
  }

  // è§¦å‘å™¨
  update() {
    console.log("è§‚å¯Ÿè€…ï¼š", this.name)
  }
}

// è¢«è§‚å¯Ÿè€…
class Subject {
  constructor() {
    // è§‚å¯Ÿè€…åˆ—è¡¨
    this._observers = []
  }

  // è·å– è§‚å¯Ÿè€…åˆ—è¡¨
  get obsers() {
    return this._observers
  }

  // æ·»åŠ 
  add(obser) {
    this._observers.push(obser)
  }

  // ç§»é™¤
  remove(obser) {
    this._observers = this._observers.filter((n) => n !== obser)
  }

  // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
  notify() {
    this._observers.forEach((obser) => obser.update())
  }
}
```

éªŒè¯æµ‹è¯•ä¸‹ç»“æœ

```js
// è§‚å¯Ÿè€…
const obserA = new Observer("obser-A")
const obserB = new Observer("obser-B")

// è¢«è§‚å¯Ÿè€…
const subject = new Subject()

// æ·»åŠ åˆ° è§‚å¯Ÿè€…åˆ—è¡¨
subject.add(obserA)
subject.add(obserB)

// é€šçŸ¥
subject.notify()
console.log("è§‚å¯Ÿè€…åˆ—è¡¨ï¼š", subject.obsers)
// è§‚å¯Ÿè€…ï¼š obser-A
// è§‚å¯Ÿè€…ï¼š obser-B
// è§‚å¯Ÿè€…åˆ—è¡¨ï¼š (2)Â [Observer, Observer]

// ç§»é™¤
subject.remove(obserA)

// é€šçŸ¥
subject.notify()
console.log("è§‚å¯Ÿè€…åˆ—è¡¨ï¼š", subject.obsers)
// è§‚å¯Ÿè€…ï¼š obser-B
// è§‚å¯Ÿè€…åˆ—è¡¨ï¼š [Observer]
```

### Vue åŒå‘æ•°æ®ç»‘å®š

`vue`çš„åŒå‘æ•°æ®ç»‘å®šå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°ã€‚

![vueçš„åŒå‘æ•°æ®ç»‘å®š](https://user-gold-cdn.xitu.io/2018/10/23/166a031209fc8da5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

åˆ©ç”¨ `Object.defineProperty()` å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒï¼Œè®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ `Observer`ï¼Œç”¨æ¥ç›‘å¬æ‰€æœ‰å±æ€§ï¼Œå¦‚æœå±æ€§ä¸Šå‘ä¸Šå˜åŒ–äº†ï¼Œå°±éœ€è¦å‘Šè¯‰è®¢é˜…è€… `Watcher` å»æ›´æ–°æ•°æ®ï¼Œæœ€åæŒ‡ä»¤è§£æå™¨ `Compile` è§£æå¯¹åº”çš„æŒ‡ä»¤ï¼Œè¿›è€Œä¼šæ‰§è¡Œå¯¹åº”çš„æ›´æ–°å‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ï¼Œå®ç°äº†åŒå‘ç»‘å®š~

> vue2.x æ ¸å¿ƒæ˜¯é€šè¿‡ `Object.defineProperty()` è¿™ä¸ªæ–¹æ³•å¯¹æ•°æ®åŠ«æŒï¼Œå¹¶é‡æ–°å®šä¹‰ `set` å’Œ `get` æ–¹æ³•ï¼Œä¸€æ—¦æ•°æ®å˜åŠ¨ï¼Œæ”¶åˆ°é€šçŸ¥ï¼Œæ›´æ–°è§†å›¾ã€‚

> `Vue`åœ¨åˆå§‹åŒ–æ—¶ä¼šæœ‰ä¸ªä¾èµ–æ”¶é›†å¤„ç†ï¼Œé€šè¿‡å¯¹å±æ€§å’ŒæŒ‡ä»¤çš„éå†å¤„ç†ï¼ˆè¿™é‡Œçš„å±æ€§åŒ…æ‹¬ `props`ã€`data` ç­‰ï¼ŒæŒ‡ä»¤æ˜¯é€šè¿‡ `compile` ç¼–è¯‘è¿›è¡Œè¿‡æ»¤å¤„ç†å¾—åˆ°ï¼‰ï¼Œå¾—åˆ°éœ€è¦è¿›è¡Œå“åº”å¼å¤„ç†çš„å±æ€§ï¼Œç„¶åå†é€šè¿‡ `Observer`ã€`Dep`ã€`Watcher` å®ç°ç›‘å¬ã€ä¾èµ–æ”¶é›†ã€è®¢é˜…ã€‚

æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è¯•ç€æŠŠæºç ä¸‹è½½ä¸‹æ¥ï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨æ–­ç‚¹è°ƒè¯•çœ‹ä¸€ä¸‹ `Vue` æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œå¯¹å¤§å®¶ç†è§£ `Vue` çš„è¿è¡Œé€»è¾‘å’Œè¿‡ç¨‹è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚

è¿™é‡Œæˆ‘ä»¬ç®€å•çœ‹ä¸‹ `Vue` å¯¹ `data` çš„å¤„ç†ã€‚å…¶ä»–æ¸²æŸ“è¿‡ç¨‹æš‚ä¸åˆ†æã€‚

åˆå§‹åŒ– `initData`

```js
// è¿™é‡Œçš„ $options å…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨å†™ Vue çš„æ—¶å€™
// å…¶ä¸­çš„propsã€dataã€methodã€computedç­‰å±æ€§ã€‚
function initData(vm) {
  // å¯¹ data è¿›è¡Œå¤„ç†ï¼Œå‡½æ•° / å¯¹è±¡
  let data = vm.$options.data
  // ä¸ºä»€ä¹ˆå»ºè®®å¤§å®¶vueä¸­çš„dataä½¿ç”¨å‡½æ•°å¼å†™æ³•ï¼Ÿ
  // å½“ä¸€ä¸ªç»„ä»¶è¢«å®šä¹‰ï¼Œ data å¿…é¡»å£°æ˜ä¸ºè¿”å›ä¸€ä¸ªåˆå§‹æ•°æ®å¯¹è±¡çš„å‡½æ•°ï¼Œå› ä¸ºç»„ä»¶å¯èƒ½è¢«ç”¨æ¥åˆ›å»ºå¤šä¸ªå®ä¾‹
  // å¦‚æœ data ä»ç„¶æ˜¯ä¸€ä¸ªçº¯ç²¹çš„å¯¹è±¡ï¼Œåˆ™æ‰€æœ‰çš„å®ä¾‹å°†å…±äº«å¼•ç”¨åŒä¸€ä¸ªæ•°æ®å¯¹è±¡
  // é€šè¿‡æä¾› data å‡½æ•°ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹åï¼Œæˆ‘ä»¬èƒ½å¤Ÿè°ƒç”¨ data å‡½æ•°ï¼Œ
  // ä»è€Œè¿”å›åˆå§‹æ•°æ®çš„ä¸€ä¸ªå…¨æ–°å‰¯æœ¬æ•°æ®å¯¹è±¡ã€‚
  // (jsåœ¨èµ‹å€¼objectå¯¹è±¡æ—¶ï¼Œæ˜¯ç›´æ¥ä¸€ä¸ªç›¸åŒçš„å†…å­˜åœ°å€ã€‚æ‰€ä»¥ä¸ºäº†æ¯ä¸ªç»„ä»¶çš„dataç‹¬ç«‹ï¼Œé‡‡ç”¨äº†è¿™ç§æ–¹å¼ã€‚)
  data = vm._data = typeof data === "function" ? getData(data, vm) : data || {}

  // observe data
  observe(data, true /* asRootData */)
}
```

åˆ›å»ºè§‚å¯Ÿè€… `observe`

```js
function observe(value, asRootData) {
  let ob
  // Observer
  ob = new Observer(value)
  // asRootData = true
  if (asRootData && ob) {
    ob.vmCount++
  }
  //
  return ob
}
```

è§‚å¯Ÿè€…ç±» `Observer`

```js
class Observer {
  constructor(value) {
    this.value = value
    this.dep = new Dep()
    this.vmCount = 0
    if (Array.isArray(value)) {
      this.observeArray(value)
    } else {
      this.walk(value)
    }
  }

  // å¤„ç†æ‰€æœ‰å±æ€§ï¼Œè¿›è¡Œå“åº”å¼å¤„ç†
  walk(obj) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  // æ•°ç»„ æ—¶éå†å¤„ç†
  observeArray(items) {
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i])
    }
  }
}
```

æ•°æ®åŠ«æŒï¼ŒåŒ…è£… `set` æ–¹æ³•ï¼Œç›‘å¬æ•°æ®æ›´æ–° `defineReactive`

> ç”±äº `Object.defineProperty` ä¸èƒ½å¤Ÿç›‘å¬æ•°ç»„ä¸‹æ ‡ï¼Œæ‰€ä»¥è¿™é‡Œ `Vue` å…¶å®æ˜¯æŠŠæ•°ç»„çš„åŸæœ‰æ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œæ¯”å¦‚`push`ï¼Œ`pop`ï¼Œå…ˆæ‰§è¡ŒåŸé€»è¾‘å‡½æ•°ï¼Œå¦‚æœæ˜¯å¾€æ•°ç»„æ–°å¢å…ƒç´ ï¼Œåˆ™æŠŠæ–°å¢å…ƒç´ å˜æˆå“åº”å¼ã€‚

```js
function defineReactive(obj, key, val) {
  // ä¾èµ–æ”¶é›†
  const dep = new Dep()

  // æ•°æ®åŠ«æŒï¼ŒåŒ…è£… set æ–¹æ³•æ·»åŠ  notify é€šçŸ¥
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      // å¦‚æœ watcher å­˜åœ¨ï¼Œè§¦å‘ä¾èµ–æ”¶é›†
      if (Dep.target) {
        dep.depend()
      }

      return val
    },
    set: function reactiveSetter(newVal) {
      // ...
      // æ•°æ®å˜æ›´ ==> è§¦å‘setæ–¹æ³• ==> è°ƒç”¨dep.notify()é€šçŸ¥æ›´æ–°
      dep.notify()
    },
  })
}
```

ä¾èµ–æ”¶é›†ç±» `Dep`

```js
class Dep {
  constructor() {
    this.id = uid++
    this.subs = [] // ç”¨äºå­˜æ”¾è®¢é˜…è€… Watcher
  }

  addSub(sub) {
    // sub ===> Watcher
    // è¯¥æ–¹æ³•ä¼šåœ¨ watcher æ·»åŠ è®¢é˜…æ—¶è¢«æ‰§è¡Œ
    this.subs.push(sub)
  }

  removeSub(sub) {
    // sub ===> Watcher
    remove(this.subs, sub)
  }

  // Dep.target===watcher å³ watcher.addDep
  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify() {
    // subs
    const subs = this.subs.slice()
    // è°ƒç”¨ watcher çš„ update
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}
// å­˜æ”¾å”¯ä¸€ watcher
Dep.target = null
const targetStack = []

function pushTarget (target) {
  targetStack.push(target)
  Dep.target = target
}

function popTarget () {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}
```

è®¢é˜…è€… `watcher`

```js
// åˆ å‡äº†éƒ¨åˆ†ï¼Œåªçœ‹æ ¸å¿ƒä»£ç 
class Watcher {
  constructor(vm, expOrFn, cb, options, isRenderWatcher) {
    this.vm = vm
    vm._watchers.push(this)

    this.cb = cb
    this.deps = []
    this.newDeps = []
    this.value = this.get()
    this.getter = expOrFn
  }

  // è·å–æœ€æ–° valueï¼Œ æ”¶é›†ä¾èµ–
  get() {
    pushTarget(this)

    let value
    const vm = this.vm
    value = this.getter.call(vm, vm)

    if (this.deep) {
      // æ”¶é›†åµŒå¥—å±æ€§çš„æ¯ä¸ªä¾èµ–
      traverse(value)
    }

    popTarget()
    this.cleanupDeps()

    return value
  }

  // æ·»åŠ ä¾èµ–
  // dep === class Dep
  addDep(dep) {
    this.newDeps.push(dep)
    dep.addSub(this)
  }

  // æ¸…é™¤ä¾èµ–
  cleanupDeps() {
    let i = this.deps.length
    while (i--) {
      const dep = this.deps[i]
      dep.removeSub(this)
    }
    this.deps = this.newDeps
  }

  // æä¾›æ›´æ–°çš„æ¥å£
  update() {
    this.run()
  }

  // é€šçŸ¥æ‰§è¡Œæ›´æ–°
  run() {
    const value = this.get()
    this.cb.call(this.vm, value, oldValue)
  }

  // é€šè¿‡ watcher æ”¶é›†æ‰€æœ‰ä¾èµ–
  depend() {
    let i = this.deps.length
    while (i--) {
      this.deps[i].depend()
    }
  }
}
```

é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ`Vue` åœ¨åˆå§‹åŒ–çš„æ—¶å€™å¯¹æ•´ä¸ª `data` å¯¹è±¡ä¸­çš„**æ¯ä¸ªå±æ€§**éƒ½è¿›è¡Œäº†**æ·»åŠ è®¢é˜…**ç›‘å¬å¤„ç†ï¼Œè€Œé€šè¿‡å¯¹ `set` çš„æ”¹å†™ä½¿å¾—æˆ‘ä»¬åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™å¯ä»¥è§¦å‘**é€šçŸ¥**ï¼Œè¿™æ ·ä¾¿å¯ä»¥ä½¿æ‰€æœ‰æ·»åŠ è®¢é˜…äº†çš„å±æ€§è¿›è¡Œæ›´æ–°ï¼Œç„¶åå†ç»“åˆ `Vue` çš„ `compiler` ç¼–è¯‘è¿›è¡Œ `render` å³å¯å®Œæˆè§†å›¾å±‚çš„æ›´æ–°ã€‚

åˆ°è¿™ä¸€æ­¥å·²ç»å¯ä»¥åšåˆ°å¯¹æ•°æ®çš„é€šçŸ¥æ›´æ–°ï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ `vue` æ˜¯åŒå‘æ•°æ®ç»‘å®šçš„ï¼Œåœ¨æ•°æ®å˜æ›´çš„åŒæ—¶ä¼šç»§ç»­é€šçŸ¥è§†å›¾ä¹Ÿè¿›è¡Œæ›´æ–°ã€‚å³åœ¨æ¨¡æ¿ç¼–è¯‘å™¨ `complie` çš„æ—¶å€™ä¼šå¯¹æŒ‡ä»¤ï¼ˆ`v-bind`ã€`v-modle`ç­‰ï¼‰è¿›è¡Œè¿‡æ»¤å¹¶æ·»åŠ  `Watcher` è®¢é˜…ï¼Œå®ç° `observe <===> watcher <===> complie` ä¸‰è€…ä¹‹é—´çš„ç»‘å®šä¸é€šä¿¡ ã€‚

> watcher æºç : <https://github1s.com/vuejs/vue/blob/HEAD/src/core/observer/watcher.js>

è¿™é‡Œæˆ‘å°±ä¸ç»§ç»­æ·±å…¥äº†ï¼Œæ„Ÿè§‰æœ‰ç‚¹è¯´ä¸å®Œäº†ğŸ¤£ï¼ŒçœŸè®©äººå¤´å¤§ï¼Œæ¶‰åŠçš„å†…å®¹æœ‰ç‚¹å¤šï¼Œæœ‰æœºä¼šçš„è¯ææé˜…è¯»æºç ç³»åˆ—äº†ã€‚ã€‚ã€‚ï¼Œæœ‰ç‚¹æ‰¯è¿œäº†ï¼Œå›åˆ°æ–‡ç« è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸»è¦æŠ›å‡ºè§‚å¯Ÿè€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ï¼Œä»¥åŠå¯¹ `Vue` çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸åŒå‘ç»‘å®šåŸç†æ¢è®¨ï¼Œæ”¶~

æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š[è§‚å¯Ÿè€…æ¨¡å¼å®ç°vueåŒå‘æ•°æ®ç»‘å®š](https://juejin.cn/post/6844903698154389517)

### zustand çŠ¶æ€ç®¡ç†å™¨

#### å…ˆæ¥çœ‹çœ‹ç”¨æ³•

åˆ›å»º store

```js
// store
import create from 'zustand'

// é€šè¿‡ create æ–¹æ³•åˆ›å»ºä¸€ä¸ªå…·æœ‰å“åº”å¼çš„ store
const useStore = create(set => ({
  bears: 0,
  increasePopulation: () => set(state => ({ bears: state.bears + 1 })), // å‡½æ•°å†™æ³•
  removeAllBears: () => set({ bears: 0 }) // å¯¹è±¡å†™æ³•
}))
```

ç»„ä»¶å¼•ç”¨

```js
// UI ç»„ä»¶ï¼Œå±•ç¤º bears çŠ¶æ€ï¼Œå½“çŠ¶æ€å˜æ›´æ—¶å¯å®ç°ç»„ä»¶åŒæ­¥æ›´æ–°
function BearCounter() {
  const bears = useStore(state => state.bears)
  return <h1>{bears} around here ...</h1>
}

// æ§åˆ¶ç»„ä»¶ï¼Œé€šè¿‡ store å†…éƒ¨åˆ›å»ºçš„ increasePopulation æ–¹æ³•æ‰§è¡Œç‚¹å‡»äº‹ä»¶ï¼Œå¯è§¦å‘æ•°æ®å’ŒUIç»„ä»¶æ›´æ–°
function Controls() {
  const increasePopulation = useStore(state => state.increasePopulation)
  return <button onClick={increasePopulation}>one up</button>
}
```

ç»“åˆå®˜æ–¹ç¤ºä¾‹ï¼Œå¯ä»¥ç¡®å®š `zustand` å†…éƒ¨å¯¹é€šè¿‡ `state` ç»‘å®šçš„ç»„ä»¶ï¼Œé»˜è®¤æ·»åŠ æ³¨å†Œåˆ°äº†è®¢é˜…è€…é˜Ÿåˆ—ï¼Œæ­¤æ—¶è¯¥ `bears` å±æ€§ç›¸å½“äºä¸€ä¸ªè¢«è§‚å¯Ÿè€…ï¼Œå½“ `bears` çŠ¶æ€å˜æ›´åï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…äº†è¯¥æ•°å±æ€§çš„ç»„ä»¶è¿›è¡Œæ›´æ–°ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥å¤§è‡´æ¨æµ‹ä¸€ä¸‹è¿™ä¸ª **set** æ–¹æ³•ï¼‰

åºŸè¯ä¸å¤šè¯´ï¼Œçœ‹ä»£ç ï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§åˆ›å»º `store` çš„é€»è¾‘åˆ†æï¼š

å³ `create` æ¥å—ä¸€ä¸ªå‡½æ•°ï¼ˆéå‡½æ•°æƒ…å†µæš‚æ—¶ä¸ç ”ç©¶ï¼‰ï¼Œè¿”å›æˆ‘ä»¬å®šä¹‰çš„çŠ¶æ€å’Œæ–¹æ³•ï¼Œä¸”è¯¥å‡½æ•°æ˜¯æä¾› `set` æ–¹æ³•ä¾›æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œè€Œè¿™ä¸ª `set` æ–¹æ³•å¿…å®šæ˜¯å¯ä»¥è§¦å‘æ›´æ–°é€šçŸ¥çš„ã€‚

#### ç›´æ¥ä¸Šä»£ç 

- `create` æ–¹æ³•

```js
function create(createState) {
  // åˆå§‹åŒ–å¤„ç† createState
  const api = typeof createState === "function" ? createImpl(createState) : createState
}
```

- è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ª `createImpl` æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•å¯¹ `createState` çš„å¤„ç†å’Œè¿”å›å€¼ã€‚

```js
function createImpl(createState) {
  // ç”¨äºç¼“å­˜ä¸Šä¸€æ¬¡çš„ çŠ¶æ€
  let state
  // ç›‘å¬é˜Ÿåˆ—
  const listeners = new Set()

  const setState = (partial, replace) => {
    // å¦‚æœæ˜¯ function æ³¨å…¥ state å¹¶è·å–æ‰§è¡Œç»“æœï¼Œå¦åˆ™ç›´æ¥å–å€¼
    // ä¾‹å¦‚ï¼šsetCount: ()=> set(state=> ({state: state.count +1 })
    // ä¾‹å¦‚ï¼šsetCount: ()=> set({count: 10})
    const nextState = typeof partial === "function" ? partial(state) : partial
    // ä¼˜åŒ–ï¼šåˆ¤æ–­çŠ¶æ€æ˜¯å¦å˜åŒ–äº†ï¼Œå†æ›´æ–°ç»„ä»¶çŠ¶æ€
    if (nextState !== state) {
      // ä¸Šä¸€æ¬¡çŠ¶æ€
      const previousState = state
      // å½“å‰çŠ¶æ€æœ€æ–°çŠ¶æ€
      state = replace ? nextState : Object.assign({}, state, nextState)
      // é€šçŸ¥é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªç»„ä»¶
      listeners.forEach((listener) => listener(state, previousState))
    }
  }

  // å‡½æ•°è·å– state
  const getState = () => state

  // å­˜åœ¨ selector æˆ– equalityFn å‚æ•°æ—¶ï¼Œå¯¹è®¢é˜…æ–¹æ³•è¿›è¡Œå¤„ç†
  const subscribeWithSelector = (listener, selector = getState, equalityFn = Object.is) => {
    // å½“å‰æ‹¿åˆ°çš„å€¼
    let currentSlice = selector(state)
    // å®é™…æ·»åŠ åˆ°é˜Ÿåˆ—çš„æ˜¯ listenerToAdd æ–¹æ³•ï¼Œ
    function listenerToAdd() {
      // è®¢é˜…é€šçŸ¥æ‰§è¡Œæ—¶çš„å€¼ï¼Œå³ ä¸‹ä¸€æ¬¡æ›´æ–°çš„å€¼
      const nextSlice = selector(state)
      // å¯¹æ¯”å‰åå€¼ä¸ç›¸ç­‰ï¼Œåˆ™è§¦å‘æ›´æ–°é€šçŸ¥
      if (!equalityFn(currentSlice, nextSlice)) {
        // ä¸Šä¸€æ¬¡å€¼
        const previousSlice = currentSlice
        // æ‰§è¡Œæ·»åŠ çš„è®¢é˜…å‡½æ•°
        // ä¾‹å¦‚ï¼šuseStore.subscribe(console.log, state => state.paw)
        // ä¸­çš„ console.log
        listener((currentSlice = nextSlice), previousSlice)
      }
    }
    // add listenerToAdd
    listeners.add(listenerToAdd)
    // Unsubscribe
    return () => listeners.delete(listenerToAdd)
  }

  // æ·»åŠ è®¢é˜… 
  // åˆ—å¦‚ï¼šuseStore.subscribe(console.log, state => state.paw)
  // æ•ˆæœï¼šåªç›‘å¬ paw çš„å˜åŒ–ï¼Œé€šçŸ¥æ›´æ–°
  const subscribe = (listener, selector, equalityFn) => {
    // selector æˆ– equalityFn å‚æ•°å­˜åœ¨ï¼Œèµ°è¯¥é€»è¾‘ï¼Œæ·»åŠ æŒ‡å®šçš„è®¢é˜…é€šçŸ¥
    if (selector || equalityFn) {
      return subscribeWithSelector(listener, selector, equalityFn)
    }
    // å¦åˆ™ å¯¹æ‰€æœ‰å˜æ›´æ·»åŠ è®¢é˜…é€šçŸ¥
    listeners.add(listener)
    // Unsubscribe
    // æ‰§è¡Œç»“æœä¸ºåˆ é™¤è¯¥è®¢é˜…è€…å‡½æ•°
    // å³ï¼šconst unsubscribe= subscribe() = () => listeners.delete(listener)
    return () => listeners.delete(listener)
  }

  // æ¸…é™¤ è®¢é˜…
  const destroy = () => listeners.clear()
  // è¿”å›ç»™ create æ–¹æ³•çš„å¤„ç†ç»“æœï¼Œå³è¿”å›äº† 4 ä¸ªå¤„ç†æ–¹æ³•
  const api = { setState, getState, subscribe, destroy }
  // å…¶å¯¹ä¼ å…¥çš„ createState å‡½æ•°æ³¨å…¥äº†3ä¸ªå‚æ•° setState, getState, api 
  // ä½¿å¾—åœ¨ create åˆ›å»º storeæ—¶ï¼Œå¯ä»¥åœ¨å›è°ƒå‡½æ•°çš„å‚æ•°é‡Œå–ç”¨æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œå¤„ç†
  // å¦‚ï¼šcreate(set=> ({count: 0,setCount: ()=> set(state=> ({state: state.count +1 }))}))
  // å¹¶è°ƒç”¨ç„¶åè¿”å› api = { setState, getState, subscribe, destroy } å±æ€§æ–¹æ³•
  state = createState(setState, getState, api)

  return api
}
```

> å¯ä»¥å¾—åˆ° createImpl çš„æ‰§è¡Œç»“æœ
>
> const api = { setState, getState, subscribe, destroy }

ç„¶åæˆ‘ä»¬å†å›æ¥ç»§ç»­å¾€ä¸‹åˆ†æ `create` æ–¹æ³•

- ç®€å•ä»‹ç»ä¸‹ä»£ç ä¸­ä½¿ç”¨çš„ `useEffect` / `useLayoutEffect` åŒºåˆ«

  - `useEffect` æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œè€Œ `useLayoutEffect` æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚
  - `useEffect` çš„æ‰§è¡Œæ—¶æœºæ˜¯æµè§ˆå™¨å®Œæˆæ¸²æŸ“ä¹‹åï¼Œè€Œ `useLayoutEffect` çš„æ‰§è¡Œæ—¶æœºæ˜¯æµè§ˆå™¨æŠŠå†…å®¹çœŸæ­£æ¸²æŸ“åˆ°ç•Œé¢ä¹‹å‰ï¼Œå’Œ `componentDidMount` ç­‰ä»·ã€‚

- `create` æ–¹æ³•

```js
import { useReducer, useLayoutEffect, useRef } from "react"

// æ˜¯å¦ä¸ºéæµè§ˆå™¨ç¯å¢ƒ
const isSSR =
  typeof window === "undefined" ||
  !window.navigator ||
  /ServerSideRendering|^Deno\//.test(window.navigator.userAgent)

// useEffect å¯ä»¥åœ¨æœåŠ¡ç«¯ï¼ˆNodeJsï¼‰æ‰§è¡Œï¼Œè€Œ useLayoutEffect ä¸è¡Œ
const useIsomorphicLayoutEffect = isSSR ? useEffect : useLayoutEffect

export default function create(createState) {
  const api = typeof createState === "function" ? createImpl(createState) : createState

  // è¿”å› useStore å‡½æ•°ä¾›å¤–éƒ¨ä½¿ç”¨
  // é—­åŒ…ä½¿å¾— api ä½œä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä¾› useStore å†…éƒ¨ä½¿ç”¨ï¼Œä¿è¯æ•°æ®éš”ç¦»
  const useStore = (selector, equalityFn = Object.is) => {
    // ç”¨äºè§¦å‘ç»„ä»¶æ›´æ–°
    const [, forceUpdate] = useReducer((c) => c + 1, 0)

    // è·å– state
    const state = api.getState()
    // æŠŠ state æŒ‚è½½åˆ° useRefï¼Œé¿å…å‰¯ä½œç”¨å¯¹å…¶è¿›è¡Œå½±å“è€Œæ›´æ–°
    const stateRef = useRef(state)
    // æŒ‚è½½æŒ‡å®š selector æ–¹æ³•åˆ° useRef
    // åˆ—å¦‚ï¼šconst bears = useStore(state => state.bears)
    const selectorRef = useRef(selector)
    // ç­‰å€¼æ–¹æ³•
    const equalityFnRef = useRef(equalityFn)
    // æ ‡è®°é”™è¯¯
    const erroredRef = useRef(false)

    // å½“å‰ state å±æ€§ï¼ˆstate.bearsï¼‰
    const currentSliceRef = useRef()
    // ç©ºå€¼å¤„ç†
    if (currentSliceRef.current === undefined) {
      currentSliceRef.current = selector(state)
    }

    let newStateSlice
    let hasNewStateSlice = false

    // The selector or equalityFn need to be called during the render phase if
    // they change. We also want legitimate errors to be visible so we re-run
    // them if they errored in the subscriber.
    if (
      stateRef.current !== state ||
      selectorRef.current !== selector ||
      equalityFnRef.current !== equalityFn ||
      erroredRef.current
    ) {
      // Using local variables to avoid mutations in the render phase.
      newStateSlice = selector(state)
      // æ–°æ—§å€¼æ˜¯å¦ç›¸ç­‰
      hasNewStateSlice = !equalityFn(currentSliceRef.current, newStateSlice)
    }

    // Syncing changes in useEffect.
    useIsomorphicLayoutEffect(() => {
      if (hasNewStateSlice) {
        currentSliceRef.current = newStateSlice
      }
      stateRef.current = state
      selectorRef.current = selector
      equalityFnRef.current = equalityFn
      erroredRef.current = false
    })

    // æš‚å­˜ state
    const stateBeforeSubscriptionRef = useRef(state)
    // åˆå§‹åŒ–
    useIsomorphicLayoutEffect(() => {
      const listener = () => {
        try {
          // è§¦å‘æ›´æ–°æ—¶çš„æœ€æ–°è·å– state
          const nextState = api.getState()
          // æ³¨å…¥ nextState æ‰§è¡Œä¼ å…¥çš„ selector æ–¹æ³•ï¼Œè·å–å€¼ï¼Œå³ state.bears
          const nextStateSlice = selectorRef.current(nextState)
          // å¯¹æ¯”ä¸ç›¸ç­‰ ==> æ›´æ–°
          if (!equalityFnRef.current(currentSliceRef.current, nextStateSlice)) {
            // æ›´æ–° stateRef ä¸ºæœ€æ–° state
            stateRef.current = nextState
            // æ›´æ–° currentSliceRef ä¸ºæœ€æ–°å±æ€§å€¼ï¼Œå³ state.bears
            currentSliceRef.current = nextStateSlice
            // æ›´æ–°ç»„ä»¶
            forceUpdate()
          }
        } catch (error) {
          // ç™»è®°é”™è¯¯
          erroredRef.current = true
          // æ›´æ–°ç»„ä»¶
          forceUpdate()
        }
      }
      // æ·»åŠ  listener è®¢é˜…
      const unsubscribe = api.subscribe(listener)
      // stateå·²ç»å˜æ›´ï¼Œé€šçŸ¥æ›´æ–°
      if (api.getState() !== stateBeforeSubscriptionRef.current) {
        listener() // state has changed before subscription
      }
      // å¸è½½æ—¶ æ¸…é™¤è®¢é˜…
      return unsubscribe
    }, [])

    return hasNewStateSlice ? newStateSlice : currentSliceRef.current
  }

  // åˆå¹¶ api å±æ€§åˆ° useStore
  Object.assign(useStore, api)

  // é—­åŒ…æš´éœ²å”¯ä¸€ æ–¹æ³•ä¾›å¤–éƒ¨ä½¿ç”¨
  return useStore
}
```

- ç®€å•æ€»ç»“ä¸‹

1. åˆ›å»º `store` æ‹¿åˆ°å¯¹å¤–æš´éœ²å”¯ä¸€æ¥å£ `useStore` ï¼Œå®šä¹‰å…¨å±€çŠ¶æ€ã€‚
2. é€šè¿‡ `const bears = useStore(state => state.bears)` è·å–çŠ¶æ€å¹¶ä¸ç»„ä»¶ç»‘å®šã€‚

   - è¿™ä¸€æ­¥ `store` ä¼šæ‰§è¡Œ `subscribe(listener)` æ·»åŠ è®¢é˜…æ“ä½œï¼ŒåŒæ—¶è¯¥æ–¹æ³•å†…ç½®æœ‰ `forceUpdate()` å‡½æ•°ç”¨äºè§¦å‘ç»„ä»¶æ›´æ–°ã€‚

3. ä½¿ç”¨ `set` é’©å­å‡½æ•°ä¿®æ”¹çŠ¶æ€ã€‚

   - å³è°ƒç”¨çš„ `setState` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œ `listeners.forEach((listener) => listener(state, previousState))` é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…æ‰§è¡Œæ›´æ–°ã€‚

## ç»“è¯­

è§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒè®¢é˜…æ¨¡å¼åœ¨å®é™…é¡¹ç›®ä¸­éå¸¸å¸¸è§ï¼Œå¾ˆå¤šä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“ä¹Ÿæ˜¯å€Ÿé‰´äº†è¿™ä¸¤ç§è®¾è®¡æ¨¡å¼çš„æ€æƒ³ â€”â€” æ¯”å¦‚ `Vue`ï¼Œ`Vue Event`ï¼Œ`React Event`ï¼Œ`RxJS`ï¼Œ`Redux`ï¼Œ`zustand` ç­‰ã€‚

å¯¹äºé¡¹ç›®ä¸­ä¸€äº›é€»è¾‘çš„è§£è€¦æˆ–è€…è§£å†³ä¸€äº›å¼‚æ­¥çš„é—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚å¯ä»¥æ¯«ä¸å¤¸å¼ çš„è¯´ï¼š**å‘å¸ƒè®¢é˜…æ¨¡å¼**/**è§‚å¯Ÿè€…æ¨¡å¼**å¯ä»¥è§£å†³å¤§éƒ¨åˆ†è§£è€¦é—®é¢˜ã€‚

æ€»çš„æ¥è¯´ï¼Œé˜…è¯»å­¦ä¹ ä¸€äº›ä¼˜ç§€çš„åº“ï¼ˆåŒ…æ‹¬ä¸€äº›å®ƒä»¬å†…éƒ¨å°è£…çš„å·¥å…·å‡½æ•°ï¼Œæœ‰å¾ˆå¤šå·§å¦™çš„è®¾è®¡å’Œå®ç°ï¼‰ï¼Œè¿™ç§æºç å­¦ä¹ å¯¹äºæˆ‘ä»¬è‡ªèº«æˆé•¿ä¸æŠ€æœ¯æ‹“å±•æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šè¢«å¤§ä½¬ä»¬çš„ç‹¬ç‰¹æ€è·¯å’Œè®¾è®¡æ‰€æŠ˜æœï¼Œè€Œé€šè¿‡è¿›ä¸€æ­¥ç†è§£æŒæ¡ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å¸æ”¶è‡ªç”¨ï¼Œåœ¨æ—¥åçš„å®æˆ˜é¡¹ç›®ä¸­**å¤§æ˜¾èº«æ‰‹**ï¼Œå²‚ä¸ç¾å“‰ï¼ğŸ˜

## ç”¨ä¾‹

<https://github.com/JS-banana/subob-subpub>

## å‚è€ƒ

- [è§‚å¯Ÿè€…æ¨¡å¼ vs å‘å¸ƒ-è®¢é˜…æ¨¡å¼](https://juejin.cn/post/6844903513009422343)
- [ä»‹ç»ä¸‹è§‚å¯Ÿè€…æ¨¡å¼å’Œè®¢é˜…-å‘å¸ƒæ¨¡å¼çš„åŒºåˆ«ï¼Œå„è‡ªé€‚ç”¨äºä»€ä¹ˆåœºæ™¯](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/25)
- [è§‚å¯Ÿè€…æ¨¡å¼ä¸å‘å¸ƒè®¢é˜…æ¨¡å¼çœŸçš„ä¸åŒ](https://juejin.cn/post/6844903842501378055)
- [å‘å¸ƒè®¢é˜…æ¨¡å¼](https://juejin.cn/post/6844903928413306887)
- [æ·±å…¥å‘å¸ƒè®¢é˜…æ¨¡å¼](https://www.clloz.com/programming/front-end/js/2020/10/18/observer-pub-sub-pattern/)
- [JavaScriptè®¾è®¡æ¨¡å¼ä¹‹è§‚å¯Ÿè€…æ¨¡å¼](https://juejin.cn/post/6844903698154389517)
- [JSè®¾è®¡æ¨¡å¼ä¹‹è§‚å¯Ÿè€…æ¨¡å¼](https://zhuanlan.zhihu.com/p/357911263)
- [è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆJavaScriptå®ç°ï¼‰](https://juejin.cn/post/6844904134840156168)
- [vue](https://github.com/vuejs/vue)
- [zustand](https://github.com/pmndrs/zustand)
- [useLayoutEffectå’ŒuseEffectçš„åŒºåˆ«](https://zhuanlan.zhihu.com/p/348701319)
