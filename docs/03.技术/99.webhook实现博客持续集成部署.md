---
title: WebHook结合GitHub Action与Coding（或Gitee）实现博客持续集成部署到个人服务器
date: 2021-01-25 21:52:47
permalink: /pages/337720/
categories:
  - 技术
tags:
  - 服务器
---

## 需求及场景

总所周知，`GitHub`作为全球最大同性交友社区，为了与大家更方便友好积极的交流 🐶，我的源码存放地址首先肯定是`GitHub`，内容包括博客的更新及一些测试用例和Demo等。

因为我的博客是部署在阿里云的个人服务器上，有时博客更新又比较频繁，一开始是通过ssh链接到服务器后然后通过命令`git clone`、`git pull`、`npm run build` 这种操作方法去手动进行更新，这里存在几个问题：

1. 频繁登录服务器，非常繁琐
2. `GitHub` 速度问题，每次更新都要等待很久
3. 服务器性能问题，对于低配服务器执行 `npm run build` 打包很吃力

<!-- more -->

## 方案一：scp 命令直接部署到服务器

### 思路

通过使用`scp`命令直接把本地部署文件拷贝至远程服务器

`scp`是secure copy的简写，是 linux 系统下基于 `ssh` 登陆进行安全的远程文件拷贝命令，`scp`传输是加密的。

- 本地进行build打包编译

- 直接通过上传替换源文件进行更新

    ```bash
    # 1. 该命令会把当前目录下的dist文件遍历上传到blog目录下：/blog/dist
    scp -r ./dist root@ip/usr/local/app/blog/
    # 2. 输入服务器密码，等待传输完成即可
    # 当然也可以通过ssh的方式无密码上传，但这个并不能达到我们最终目标。
    
    ```

### 效果

- ~~服务器编译的性能问题已解决~~
- ~~GitHub更新拉取速度慢的问题已解决~~
- 每次更新执行打包编译、登录操作等步骤依旧繁琐

## 方案二：GitHub Action Pages

### 思路

通过使用`GitHub`提供的`Page` 与 `Action`服务实现`gh-pages`持续集成与部署

**GitHub Page**是Github提供的一款免费的~，用于托管个人的静态网站，可以用它来搭建私人博客，也算是省去了购买服务器、域名等等一系列复杂的操作。

**规则**：建立一个仓库命名为 `用户名.github.io`
**使用**：仓库下创建一个`index.html`文件访问网址即可查看

gh-pages 的搭建教程网上很多，具体实现我就不再重复了。

这里我提供一种我的方案：

通过动态生成`gh-pages`分支并推送到github仓库实现多地址部署

如我的博客的`GitHub`地址：[https://JS-banana.github.io/vuepress](https://JS-banana.github.io/vuepress)

### 脚本编写

- 根目录下创建 `.github>workflows>ci.yml`
- ci.yml文件

    ```yml
    jobs: # 工作流
      build: # 自定义名称
      runs-on: ubuntu-latest #运行在虚拟机环境ubuntu-latest

      strategy:
        matrix:
        node-version: [14.x]

      steps: # 步骤
        - name: Checkout # 步骤1
        uses: actions/checkout@v1 # 使用的动作。格式：userName/repoName。
        #作用：检出仓库，获取源码。 官方actions库：https://github.com/actions
        - name: Use Node.js ${{ matrix.node-version }} # 步骤2
        uses: actions/setup-node@v1 # 作用：安装nodejs
        with:
          node-version: ${{ matrix.node-version }} # 版本
        - name: run deploy.sh # 步骤3 部署到github gh-pages
        env: # 设置环境变量
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # token私密变量
        run: 
          - npm install
          - npm run build
          - cd ./dist
          - git init
          - git config user.name "name"
          - git config user.email "email"
          - git add .
          - git commit -m "$(date) Update from Action"
          - git push --force --quiet "https://JS-banana:${GITHUB_TOKEN}@github.com/JS-banana/vuepress.git" master:gh-pages
    ```

该page项目可以作为备选地址使用，通过`CNAME`定向到我们自己的域名服务器下。

**CNAME**：即别名记录。这种记录允许您将多个名字映射到另外一个域名。

`echo 'ssscode.com' > CNAME`

`CNAME`文件放到生成的`dist`目录下，这一步可以通过`bash`脚本处理

- 我们把上面的脚本再调整下

    ```yml
    jobs: # 工作流
      build: # 自定义名称
      runs-on: ubuntu-latest #运行在虚拟机环境ubuntu-latest

      strategy:
        matrix:
        node-version: [14.x]

      steps: # 步骤
        - name: Checkout # 步骤1
        uses: actions/checkout@v1 # 使用的动作。格式：userName/repoName。
        #作用：检出仓库，获取源码。 官方actions库：https://github.com/actions
        - name: Use Node.js ${{ matrix.node-version }} # 步骤2
        uses: actions/setup-node@v1 # 作用：安装nodejs
        with:
          node-version: ${{ matrix.node-version }} # 版本
        - name: run deploy.sh # 步骤3 部署到github gh-pages
        env: # 设置环境变量
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }} # token私密变量
        run: npm install && npm run deploy
    ```

- 创建`deploy.sh`文件,并在`package.json`字段`scripts`下添加`"deploy": "bash deploy.sh"`命令

    ```sh
    #!/usr/bin/env sh

    # 确保脚本抛出遇到的错误
    set -e

    # date
    nowDate=$(date "+%Y-%m-%d %H:%M:%S")

    # 生成静态文件
    npm run build

    # 进入生成的文件夹
    cd ./dist
    
    # var
    githubUrl=https://JS-banana:${GITHUB_TOKEN}@github.com/JS-banana/vuepress.git

    # deploy
    echo 'ssscode.com' > CNAME
    git init
    git add -A
    git commit -m "deploy.sh===>update：${nowDate}"
    git push -f $githubUrl master:gh-pages # 推送到github
    cd - # 退回开始所在目录
    rm -rf ./dist
    ```

## 方案三：Coding与GitHub同步部署

## 方案四：Webhook与Coding实现持续部署